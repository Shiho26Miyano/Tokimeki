<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0">
    <meta name="version" content="20250117-1704067200">
    <meta name="last-modified" content="2025-01-17">
    <title>Tokimeki - AI-Powered Investment Analysis Platform | CaddieAlpha‚Ñ¢ Golf Strategy</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
    <style>
        body, .card-title, .form-label, .card-body, .card-section-vertical, .mb-2, .mb-3, .mb-4, .market-controls, .explore-controls, .poetry-controls, .d3-tooltip, .chart-area, .container, .row, .col-12, .d-flex, .text-center, .text-muted, .fs-6 {
            font-family: 'Inter', 'Roboto', Arial, sans-serif !important;
            color: #183153 !important;
            font-size: 1rem;
        }
        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #183153 !important;
            letter-spacing: 0.01em;
            text-align: left;
            margin-bottom: 0;
            line-height: 1.1;
            text-transform: none;
            white-space: nowrap;
        }
        .form-label {
            color: #183153 !important;
            font-weight: 500;
            font-size: 1rem;
            margin-bottom: 0;
            white-space: nowrap;
        }
        .d3-tooltip {
            color: #183153 !important;
            font-size: 1rem;
        }
        body { font-family: Inter, Roboto, Arial, sans-serif; background: #fff; color: #222; }
        .container { max-width: 900px; margin: 0 auto; padding-top: 2.5rem; }
        .letsplay-row img { width: 60px; height: 60px; object-fit: cover; border-radius: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.13); margin-bottom: 4px; }
        .letsplay-row h1 { font-size: 1.5rem; color: #183153; letter-spacing: 0.5px; margin: 0; font-weight: 700; }
        .noUi-target { background: #e0e0e0; border-radius: 8px; border: none; height: 8px; margin-top: 18px; }
        .noUi-connect { background: #183153; border-radius: 8px; }
        .noUi-horizontal .noUi-handle { width: 18px; height: 18px; border-radius: 50%; background: #183153; border: 2px solid #fff; top: -5px; cursor: pointer; }
        .noUi-tooltip { background: #fff; color: #183153; border-radius: 6px; border: 1px solid #183153; font-size: 0.95em; padding: 2px 8px; }
        select:disabled { background: #f3f3f3; color: #aaa; border-color: #ddd; cursor: not-allowed; }
        .row.g-4 { gap: 1.5rem 0; flex-direction: column; }
        .card { min-height: 100%; background: #fff; border: 1px solid #e0e0e0; box-shadow: 0 2px 16px rgba(16,26,43,0.07); border-radius: 14px; padding: 1.2rem 1.2rem 1.2rem 1.2rem; display: flex; flex-direction: column; justify-content: stretch; margin-bottom: 0.6rem; }
        .card-header-row { display: flex; flex-wrap: wrap; align-items: center; gap: 1.1rem; margin-bottom: 0.7rem; }
        .card-section-vertical { display: flex; flex-direction: column; gap: 0.4rem; }
        .chart-area {
            background: #fff;
            border-radius: 12px;
            padding: 1.2rem 1.2rem 1.2rem 1.2rem;
            min-width: 320px;
            width: 100%;
            max-width: 900px;
            height: 340px;
            aspect-ratio: unset;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin: 0 auto;
        }
        #d3-stock-chart, #volatility-correlation-chart {
            width: 100%;
            height: 100%;
            min-height: 0;
            min-width: 0;
            max-width: 100%;
            margin: 0 auto;
            overflow-x: auto;
            background: transparent;
        }
        .market-controls, .explore-controls, .poetry-controls { display: flex; flex-wrap: wrap; align-items: center; gap: 0.7rem; margin-bottom: 0; }
        .btn-dark-bbg { background: #183153; color: #fff; font-weight: 500; border: none; font-size: 1rem; padding: 0.38rem 1.1rem; }
        .btn-dark-bbg:hover { background: #27457c; color: #fff; }
        .btn-outline-secondary { border-color: #183153; color: #183153; background: transparent; font-size: 1rem; padding: 0.38rem 1.1rem; }
        .btn-outline-secondary:hover { background: #183153; color: #fff; }
        .form-select, .form-control { background: #fff; color: #222; border: 1px solid #ccc; font-size: 1rem; }
        .form-select:focus, .form-control:focus { border-color: #183153; box-shadow: 0 0 0 2px #18315333; }
        .mb-2, .mb-3, .mb-4 { margin-bottom: 0.7rem !important; }
        .mb-4 { margin-bottom: 1.1rem !important; }
        .d-flex.align-items-end.gap-2 { gap: 0.3rem; }
        .row.g-4 > [class^='col-'] { display: flex; flex-direction: column; }
        .card-body { flex: 1 1 auto; display: flex; flex-direction: column; padding: 0.6rem 1rem 0.6rem 1rem; }
        .divider { display: none; }
        
        /* Golf Factor Analysis Styles */
        .score-excellent { background: #2a9d8f; color: white; }
        .score-good { background: #7fb069; color: white; }
        .score-fair { background: #f4a261; color: white; }
        .score-poor { background: #e76f51; color: white; }
        
        /* Fix for golf course recommendation text selection issue */
        .card[onclick] {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        
        .card[onclick] .text-muted {
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            text-decoration: none !important;
            background: none !important;
            color: #6c757d !important;
        }
        
        /* Additional fix for recommendation text highlighting */
        .card[onclick] small.text-muted {
            background: transparent !important;
            text-decoration: none !important;
            color: #6c757d !important;
            user-select: text !important;
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
        }
        
        /* Prevent text selection highlighting on clickable cards */
        .card[onclick] * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        /* Allow text selection only on recommendation text */
        .card[onclick] .text-muted,
        .card[onclick] small.text-muted {
            -webkit-user-select: text !important;
            -moz-user-select: text !important;
            -ms-user-select: text !important;
            user-select: text !important;
            background: transparent !important;
            text-decoration: none !important;
        }
        
        /* Loading Timer Styles */
        .loading-timer-container {
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 1px solid #dee2e6;
        }
        
        .loading-progress {
            margin: 0 auto;
            max-width: 300px;
        }
        
        .progress {
            background-color: rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .progress-bar {
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .loading-text {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .loading-timer-container small {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .loading-timer-container .spinner-border {
            width: 2.5rem;
            height: 2.5rem;
            border-width: 0.3em;
        }
        
        .grade-a { color: #2a9d8f; }
        .grade-b { color: #7fb069; }
        .grade-c { color: #f4a261; }
        .grade-d { color: #e76f51; }
        
        @media (max-width: 991px) {
            .container { padding: 0.5rem; }
            .card-header-row, .market-controls, .explore-controls, .poetry-controls { flex-direction: column; align-items: flex-start; gap: 0.3rem; }
            .chart-area {
                min-width: 0;
                max-width: 100%;
                width: 100%;
                height: 220px;
                padding: 0.7rem;
            }
        }
        .col-12.d-flex + .col-12.d-flex { margin-top: -0.2rem; }
        
        /* Tech Stack Card Styles */
        .tech-badge {
            text-align: center;
        }
        
        .tech-badge .badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            width: 100%;
            display: block;
        }
        
        .card.border-primary {
            box-shadow: 0 2px 8px rgba(0,123,255,0.1);
            transition: all 0.3s ease;
        }
        
        .card.border-primary:hover {
            box-shadow: 0 4px 16px rgba(0,123,255,0.2);
            transform: translateY(-2px);
        }
        
        #main-nav .nav-link {
            color: #183153;
            font-weight: 500;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
        }
        #main-nav .nav-link.active,
        #main-nav .nav-link:hover {
            background-color: #183153;
            color: #fff;
        }
        #left-nav-container {
            background-color: #f8f9fa;
            padding: 1rem;
            border-right: 1px solid #dee2e6;
            height: 100vh;
            position: sticky;
            top: 0;
        }
        .tab-content > .tab-pane {
            display: none;
        }
        .tab-content > .active {
            display: block;
        }
        
        /* Futures Exploratorium Styles */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes slideInLeft {
            0% { transform: translateX(-50px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            0% { transform: translateX(50px); opacity: 0; }
            100% { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideInUp {
            0% { transform: translateY(30px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(0, 212, 255, 0.5); }
            50% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.8); }
            100% { box-shadow: 0 0 5px rgba(0, 212, 255, 0.5); }
        }
        
        @keyframes slideInUp {
            0% { 
                opacity: 0;
                transform: translateY(20px);
            }
            100% { 
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes glow {
            0% { box-shadow: 0 0 5px rgba(0, 212, 255, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.6); }
            100% { box-shadow: 0 0 5px rgba(0, 212, 255, 0.3); }
        }
        
        @keyframes numberChange {
            0% { transform: scale(1); color: inherit; }
            50% { transform: scale(1.1); color: #00d4ff; }
            100% { transform: scale(1); color: inherit; }
        }
        
        @keyframes priceUpdate {
            0% { 
                transform: scale(1);
                background-color: rgba(0, 212, 255, 0.1);
            }
            50% { 
                transform: scale(1.02);
                background-color: rgba(0, 212, 255, 0.2);
            }
            100% { 
                transform: scale(1);
                background-color: rgba(0, 212, 255, 0.05);
            }
        }
        
        @keyframes sparklineDraw {
            0% { stroke-dasharray: 0 1000; }
            100% { stroke-dasharray: 1000 0; }
        }
        
        @keyframes fadeInScale {
            0% { 
                opacity: 0;
                transform: scale(0.9) translateY(10px);
            }
            100% { 
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        @keyframes priceFlash {
            0% { color: inherit; }
            50% { color: #00d4ff; }
            100% { color: inherit; }
        }
        
        #futures-exploratorium-root {
            min-height: 100vh;
        }
        
        @media (max-width: 1200px) {
            #futures-exploratorium-root .dashboard-grid {
                grid-template-columns: 1fr 1fr !important;
            }
        }
        
        @media (max-width: 768px) {
            #futures-exploratorium-root .dashboard-grid {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 768px) {
            #futures-exploratorium-root .main-content {
                padding: 0 1rem !important;
            }
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
            border-bottom: 1px dotted #000;
        }

        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: #183153;
            color: #fff;
            text-align: left;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.95rem;
            line-height: 1.4;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        /* Chat styles */
        #chat-messages {
            background: #f8f9fa;
            border: 1px solid #e0e0e0 !important;
            border-radius: 12px !important;
        }
        
        #chat-messages .message-content {
            border-radius: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        #chat-messages .user-message {
            background-color: #183153;
            color: white;
            padding: 8px 16px;
            margin: 4px 0;
            border-radius: 12px 12px 2px 12px;
        }
        
        #chat-messages .ai-message {
            background-color: white;
            color: #183153;
            padding: 8px 16px;
            margin: 4px 0;
            border-radius: 12px 12px 12px 2px;
        }
        
        #chat-messages .ai-message pre {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 12px;
            margin: 8px 0;
            overflow-x: auto;
        }
        
        #chat-messages .ai-message code {
            background: #f8f9fa;
            padding: 2px 4px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        
        #chat-input {
            border-radius: 20px;
            padding: 8px 16px;
            border: 1px solid #e0e0e0;
            transition: border-color 0.2s;
        }
        
        #chat-input:focus {
            border-color: #183153;
            box-shadow: 0 0 0 2px rgba(24, 49, 83, 0.1);
        }
        
        #send-message {
            border-radius: 20px;
            padding: 8px 24px;
        }
        
        #ai-model-select {
            border-radius: 8px;
            padding: 6px 12px;
            border: 1px solid #e0e0e0;
            background-color: #f8f9fa;
            color: #183153;
            font-size: 0.9rem;
        }
        
        .thinking-indicator {
            color: #6c757d;
            font-style: italic;
            padding: 8px 16px;
            background: rgba(24, 49, 83, 0.05);
            border-radius: 12px;
            margin: 4px 0;
        }
        
        /* Chart container fixes */
        #fq-price-chart, #fq-performance-chart, #fq-distribution-chart, #fq-price-chart-main, #fq-distribution-chart-main {
            max-height: 100% !important;
            max-width: 100% !important;
            height: auto !important;
            width: auto !important;
            display: block !important;
        }
        
        .card-body canvas {
            display: block !important;
            max-height: 300px !important;
            max-width: 100% !important;
        }
        
        #fq-price-chart, #fq-price-chart-main {
            max-height: 300px !important;
            min-height: 200px !important;
        }
        
        #fq-performance-chart {
            max-height: 250px !important;
        }
        
        #fq-distribution-chart, #fq-distribution-chart-main {
            max-height: 300px !important;
            min-height: 200px !important;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-2" id="left-nav-container">
                <div class="letsplay-row d-flex align-items-center justify-content-between gap-2 mb-4">
                    <img src="static/img/cute.png" alt="Cute" style="width: 40px; height: 40px; border-radius: 10px;">
                    <h4 class="mb-0" style="font-weight: 700;">Tokimeki</h4>
                    <img src="static/img/handsome.png" alt="Handsome" style="width: 40px; height: 40px; border-radius: 10px;">
                </div>

                <ul class="nav flex-column nav-pills" id="main-nav" role="tablist" aria-orientation="vertical">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="minigolf-strategy-tab" data-bs-toggle="pill" data-bs-target="#minigolf-strategy-content" role="tab" aria-controls="minigolf-strategy-content" aria-selected="true">üèåÔ∏è Golf Factor Analysis</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="futures-exploratorium-tab" data-bs-toggle="pill" data-bs-target="#futures-exploratorium-content" role="tab" aria-controls="futures-exploratorium-content" aria-selected="false">üöÄ Futures Exploratorium</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="futurequant-dashboard-tab" data-bs-toggle="pill" data-bs-target="#futurequant-dashboard-content" role="tab" aria-controls="futurequant-dashboard-content" aria-selected="false">üìä FutureQuant Simulator</a>
                    </li>

                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="rag-bi-tab" data-bs-toggle="pill" data-bs-target="#rag-bi-content" role="tab" aria-controls="rag-bi-content" aria-selected="false">üìö RAG Business Intelligence</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="deepseek-chatbot-tab" data-bs-toggle="pill" data-bs-target="#deepseek-chatbot-content" role="tab" aria-controls="deepseek-chatbot-content" aria-selected="false">ü§ñ Chatbot</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="ai-platform-comparables-tab" data-bs-toggle="pill" data-bs-target="#ai-platform-comparables-content" role="tab" aria-controls="ai-platform-comparables-content" aria-selected="false">ü§ñ AI Platform Comparables</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="market-overtime-tab" data-bs-toggle="pill" data-bs-target="#market-overtime-content" role="tab" aria-controls="market-overtime-content" aria-selected="false">üìà Market Overtime</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="volatility-explorer-tab" data-bs-toggle="pill" data-bs-target="#volatility-explorer-content" role="tab" aria-controls="volatility-explorer-content" aria-selected="false">üìä Volatility Explorer</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="hf-signal-tool-tab" data-bs-toggle="pill" data-bs-target="#hf-signal-tool-content" role="tab" aria-controls="hf-signal-tool-content" aria-selected="false">‚ö° Trading Strategy Analyzer</a>
                    </li>

                </ul>


                </ul>
            </div>

            <div class="col-md-10 py-4">
                <div class="tab-content" id="main-tab-content">
                    <div class="tab-pane fade" id="futures-exploratorium-content" role="tabpanel" aria-labelledby="futures-exploratorium-tab">
                        <div id="futures-exploratorium-root"></div>
                    </div>
                    <div class="tab-pane fade" id="futurequant-dashboard-content" role="tabpanel" aria-labelledby="futurequant-dashboard-tab">
                        <div id="futurequant-dashboard-root">
                            <!-- Compact Header -->
                            <div class="card shadow-sm mb-3">
                                <div class="card-body py-3">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h3 class="mb-1">
                                                <i class="fas fa-chart-line text-primary"></i> 
                                                FutureQuant Simulator
                                            </h3>

                                            
                                                                        <!-- Quick Guide -->
                            <div class="alert alert-info mt-2 mb-0 py-2 small">
                                <i class="fas fa-info-circle"></i> <strong>Quick Start:</strong> 
                                <strong>Symbol</strong> ‚Üí <strong>Strategy</strong> ‚Üí <strong>Train</strong> or <strong>Trade</strong>
                            </div>
                            
                            <!-- Backend Algorithm Info -->
                            <div class="alert alert-secondary mt-2 mb-0 py-2 small">
                                <i class="fas fa-microchip"></i> <strong>AI Engine:</strong> 
                                <span class="text-muted">ML models learn from market data to predict price movements using technical analysis</span>
                            </div>
                            
                            <!-- Academic Citation -->
                            <div class="alert alert-info mt-2 mb-0 py-2 small">
                                <i class="fas fa-graduation-cap"></i> <strong>Performance:</strong> 
                                <span class="text-muted">Based on </span>
                                <a href="https://arxiv.org/abs/2505.05595" target="_blank" class="text-decoration-none fw-bold">
                                    FutureQuant Transformer
                                </a>
                                <span class="text-muted">: 0.1193% avg gain per 30-min trade</span>
                            </div>
                            
                            <!-- Data Source Information -->
                            <div class="alert alert-info mt-2 mb-0 py-2 small">
                                <i class="fas fa-clock"></i> <strong>Data Source:</strong> 
                                <span class="text-muted">Yahoo Finance via yfinance - US market hours (9:30-4:00 ET)</span>
                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="d-flex gap-2 justify-content-end">
                                                <!-- Technical Stack Card -->
                                                <div class="card border-primary h-100" style="min-width: 200px;">
                                                    <div class="card-header bg-primary text-white text-center py-2">
                                                        <h6 class="mb-0">
                                                            <i class="fas fa-cogs"></i> FutureQuant Tech Stack
                                                        </h6>
                                                    </div>
                                                                        <div class="card-body py-2">
                        <div class="row">
                            <div class="col-6">
                                <div class="tech-badge mb-1">
                                    <span class="badge bg-primary">qf-lib</span>
                                </div>
                                <div class="tech-badge mb-1">
                                    <span class="badge bg-info">MLflow</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="tech-badge mb-1">
                                    <span class="badge bg-success">PyTorch</span>
                                </div>
                                <div class="tech-badge mb-1">
                                    <span class="badge bg-warning">scikit-learn</span>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-12">
                                <div class="tech-badge">
                                    <span class="badge bg-dark">ML + Risk Mgmt</span>
                                </div>
                            </div>
                        </div>
                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Compact Controls Row -->
                            <div class="row mb-3">
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Symbol</label>
                                    <select class="form-select form-select-sm" id="fq-symbol-select"
                                            data-bs-toggle="tooltip" data-bs-placement="top" 
                                            title="Futures contract symbols (ES=S&P500, NQ=Nasdaq, YM=Dow)">
                                        <option value="">Select</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Strategy</label>
                                    <select class="form-select form-select-sm" id="fq-strategy-select"
                                            data-bs-toggle="tooltip" data-bs-placement="top" 
                                            title="Trading strategy based on risk tolerance and market approach">
                                        <option value="">Aggressive Mean Reversion</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Timeframe</label>
                                    <select class="form-select form-select-sm" id="fq-timeframe-select">
                                        <option value="1d">1D</option>
                                        <option value="1h">1H</option>
                                        <option value="15m">15M</option>
                                        <option value="5m">5M</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Price</label>
                                    <div class="text-primary fw-bold" id="fq-current-price">$0.00</div>
                                    <small class="text-muted" id="fq-price-change">+0.00%</small>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label small mb-1">Volume</label>
                                    <div class="text-info fw-bold" id="fq-volume">0</div>
                                    <small class="text-muted">Contracts</small>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <div class="d-grid gap-1 w-100">
                                        <button class="btn btn-primary btn-sm" id="fq-train-model-btn"
                                                data-bs-toggle="tooltip" data-bs-placement="top" 
                                                title="Train AI models for futures trading - Required first step">
                                            <i class="fas fa-brain"></i> Train
                                        </button>
                                        <button class="btn btn-secondary btn-sm" id="fq-start-paper-trading-btn"
                                                data-bs-toggle="tooltip" data-bs-placement="top" 
                                                title="Start paper trading with trained models - Requires training first"
                                                disabled>
                                            <i class="fas fa-play"></i> Trade
                                        </button>
                                        <div class="text-center mt-1">
                                            <small class="text-muted" id="train-trade-status">
                                                <i class="fas fa-info-circle"></i> Train first, then Trade
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Simple Charts Section -->
                            <div class="row mb-3">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header py-2">
                                            <h6 class="mb-0"><i class="fas fa-chart-line text-primary"></i> Price Chart</h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <canvas id="simple-price-chart" height="250" style="max-height: 250px; width: 100%;"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header py-2">
                                            <h6 class="mb-0"><i class="fas fa-chart-bar text-success"></i> Distribution</h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <canvas id="simple-distribution-chart" height="250" style="max-height: 250px; width: 100%;"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- FutureQuant Strategy Concept Section -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header py-2">
                                            <h6 class="mb-0"><i class="fas fa-lightbulb text-warning"></i> FutureQuant Strategy Concept</h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="row">
                                                <div class="col-md-12">
                                                    <div class="text-center">
                                                        <h6 class="text-primary"><i class="fas fa-chart-line"></i> Distribution-Based Futures Trading Strategy</h6>
                                                        <p class="small text-muted mb-0">
                                                            Instead of predicting exact prices, the FutureQuant strategy forecasts the probability distribution of future price movements, enabling traders to make informed decisions under market uncertainty by understanding both potential gains and risks across different scenarios.
                                                        </p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            
                            <!-- Workflow Guide -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card border-info">
                                        <div class="card-header py-2 bg-info text-white">
                                            <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Trading Workflow</h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="row text-center">
                                                <div class="col-md-3">
                                                    <div class="border rounded p-2 bg-light">
                                                        <i class="fas fa-download text-primary fa-2x mb-2"></i>
                                                        <h6 class="mb-1">1. Get Data</h6>
                                                        <small class="text-muted">Download market data</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="border rounded p-2 bg-light">
                                                        <i class="fas fa-cogs text-success fa-2x mb-2"></i>
                                                        <h6 class="mb-1">2. Build Features</h6>
                                                        <small class="text-muted">Calculate indicators</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="border rounded p-2 bg-light">
                                                        <i class="fas fa-brain text-primary fa-2x mb-2"></i>
                                                        <h6 class="mb-1">3. Train Models</h6>
                                                        <small class="text-muted">AI learns patterns</small>
                                                    </div>
                                                </div>
                                                <div class="col-md-3">
                                                    <div class="border rounded p-2 bg-light">
                                                        <i class="fas fa-play text-success fa-2x mb-2"></i>
                                                        <h6 class="mb-1">4. Start Trading</h6>
                                                        <small class="text-muted">Paper trade safely</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            

                            
                            <!-- Technical Algorithm Details -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div class="card border-dark">
                                        <div class="card-header py-2 bg-dark text-white">
                                            <h6 class="mb-0"><i class="fas fa-microchip"></i> What Makes It Smart</h6>
                                        </div>
                                        <div class="card-body py-2">
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <h6 class="text-primary"><i class="fas fa-brain"></i> AI Learning</h6>
                                                    <ul class="small text-muted mb-0">
                                                        <li><strong>Smart Models:</strong> AI that gets better over time</li>
                                                        <li><strong>Multiple Approaches:</strong> Combines different prediction methods</li>
                                                        <li><strong>Probability Estimates:</strong> Shows confidence in predictions</li>
                                                        <li><strong>Market Patterns:</strong> Recognizes 50+ trading signals</li>
                                                    </ul>
                                                </div>
                                                <div class="col-md-6">
                                                    <h6 class="text-success"><i class="fas fa-chart-line"></i> Trading Strategy</h6>
                                                    <ul class="small text-muted mb-0">
                                                        <li><strong>Pattern Recognition:</strong> Finds when prices are too high/low</li>
                                                        <li><strong>Trend Following:</strong> Rides market momentum</li>
                                                        <li><strong>Risk Control:</strong> Manages position sizes and losses</li>
                                                        <li><strong>Fast Signals:</strong> Updates predictions every second</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    

                    <div class="tab-pane fade" id="rag-bi-content" role="tabpanel" aria-labelledby="rag-bi-tab">
                        <div id="rag-bi-root"></div>
                    </div>
                    <div class="tab-pane fade" id="ai-platform-comparables-content" role="tabpanel" aria-labelledby="ai-platform-comparables-tab">
                        <div class="card shadow-sm flex-fill d-flex flex-column" style="max-width: 1100px; margin: 0 auto; border-radius: 16px;">
                            <div class="card-body d-flex flex-column" style="padding: 32px;">
                                <div class="card-header-row mb-3">
                                    <span class="card-title" style="font-size: 2rem; font-weight: 600; color: #183153;">ü§ñ AI Platform Comparables</span>
                                </div>
                                <div class="alert alert-info mb-4" style="background: #f1f5fa; color: #27457c; border: none; border-radius: 10px;">
                                    <strong>What is this?</strong> This section compares leading AI/LLM platforms and toolkits that serve as alternatives or complements to <b>OpenRouter</b> for LLM access, orchestration, monitoring, and local inference.
                                </div>
                                <!-- Interactive Filters -->
                                <div class="mb-3 d-flex flex-wrap align-items-center" id="ai-platform-filters">
                                    <input type="text" id="ai-platform-search" class="form-control me-3" style="max-width: 260px; margin-bottom: 8px;" placeholder="Search platforms or features...">
                                    <div class="d-flex flex-wrap gap-2">
                                        <span class="badge bg-primary filter-chip" data-category="Commercial">Commercial</span>
                                        <span class="badge bg-success filter-chip" data-category="Open-Source">Open-Source</span>
                                        <span class="badge bg-info filter-chip" data-category="Monitoring">Monitoring</span>
                                        <span class="badge bg-warning text-dark filter-chip" data-category="Orchestration">Orchestration</span>
                                        <span class="badge bg-secondary filter-chip" data-category="Local">Local</span>
                                    </div>
                                </div>
                                <!-- Chart Placeholder -->
                                <div class="mb-4" style="background: #f8fafc; border-radius: 10px; padding: 18px 10px; text-align: center;">
                                    <canvas id="ai-platform-chart" width="600" height="220" style="max-width: 100%; margin-bottom: 8px;"></canvas>
                                    <div style="color: #888; font-size: 0.98rem;">(Interactive chart coming soon: popularity, speed, or cost comparison)</div>
                                </div>
                                <h2 style="font-size: 1.3rem; margin-top: 24px; margin-bottom: 12px; color: #27457c;">Platform Comparison</h2>
                                <div class="table-responsive mb-4">
                                    <table class="table table-bordered" id="ai-platform-table" style="background: #fff; cursor: pointer;">
                                        <thead class="table-light">
                                            <tr>
                                                <th data-sort="Platform">Platform</th>
                                                <th data-sort="Description">Description</th>
                                                <th data-sort="Key Features">Key Features</th>
                                                <th data-sort="Notes">Notes</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr data-category="Commercial">
                                                <td>OpenRouter</td><td>Unified API for commercial LLMs</td><td>OpenAI, Anthropic, Cohere, Mistral, etc.; OpenAI-compatible API</td><td>Best for commercial LLM aggregation</td>
                                                <td><a href="https://openrouter.ai/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Open-Source">
                                                <td>Together.ai</td><td>Open LLM inference platform</td><td>Mixtral, LLaMA, Gemma, etc.; OpenAI-compatible API</td><td>Often free/cheaper, focused on open models</td>
                                                <td><a href="https://www.together.ai/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Open-Source">
                                                <td>Hugging Face</td><td>Model hub & inference endpoints</td><td>100,000+ models, Spaces, datasets, OSS focus</td><td>Largest OSS model library</td>
                                                <td><a href="https://huggingface.co/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Open-Source">
                                                <td>Fireworks.ai</td><td>OSS LLM hosting at scale</td><td>Fast, OpenAI-style endpoint, Mistral, LLaMA2</td><td>Production-grade OSS LLMs</td>
                                                <td><a href="https://fireworks.ai/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Open-Source">
                                                <td>Groq API</td><td>Ultra-fast inference (Mixtral)</td><td>Low latency, custom hardware, Mixtral</td><td>Limited to select models</td>
                                                <td><a href="https://groq.com/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Open-Source">
                                                <td>Anyscale Endpoints</td><td>Hosted open LLMs</td><td>OpenAI-compatible, Ray-based, cost-efficient</td><td>Performance/cost focus</td>
                                                <td><a href="https://www.anyscale.com/endpoints" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Local">
                                                <td>Ollama (local)</td><td>Run LLMs locally</td><td>CLI/API, LLaMA2, Code LLaMA, Mistral</td><td>For local/dev use only</td>
                                                <td><a href="https://ollama.com/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Commercial">
                                                <td>Vercel AI SDK</td><td>LLM app toolkit</td><td>Unified LLM access, OpenAI, Anthropic, Cohere</td><td>Requires Vercel + backend</td>
                                                <td><a href="https://vercel.com/docs/ai" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Orchestration">
                                                <td>LangChain</td><td>LLM orchestration framework</td><td>Multi-LLM routing, agents, plugins</td><td>You write orchestration logic</td>
                                                <td><a href="https://www.langchain.com/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Monitoring">
                                                <td>Helicone</td><td>LLM API logging/monitoring</td><td>Proxy, dashboards, analytics</td><td>Not a router, but often used with OpenRouter</td>
                                                <td><a href="https://www.helicone.ai/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                            <tr data-category="Monitoring">
                                                <td>PromptLayer</td><td>Prompt management & tracking</td><td>Logs, versions, routes prompts</td><td>Great for prompt versioning</td>
                                                <td><a href="https://www.promptlayer.com/" target="_blank" class="btn btn-outline-primary btn-sm">Learn More</a></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <h2 style="font-size: 1.15rem; margin-top: 24px; margin-bottom: 10px; color: #27457c;">Parameter Explanations</h2>
                                <div class="alert alert-secondary mb-4" style="background: #f8fafc; color: #183153; border: none; border-radius: 10px;">
                                    <div style="margin-bottom: 8px;"><strong>Model:</strong> Choose the AI model that best fits your needs. Each model has different strengths and capabilities.</div>
                                    <div style="margin-bottom: 8px;"><strong>Temperature:</strong> Controls randomness in responses. Lower values (0.1-0.3) make responses more focused and deterministic. Higher values (0.7-1.0) make responses more creative and varied. Range: 0.0 to 2.0.</div>
                                    <div><strong>Max Tokens:</strong> Limits the length of the AI response. Higher values allow longer, more detailed responses. Lower values create shorter, more concise answers. Range: 100 to 4000 tokens.</div>
                                </div>
                                <h2 style="font-size: 1.15rem; margin-top: 24px; margin-bottom: 10px; color: #27457c;">üß† Summary of Positioning</h2>
                                <ul style="margin-bottom: 24px;">
                                    <li><b>Best router for commercial LLMs:</b> OpenRouter</li>
                                    <li><b>Best for open-source LLMs:</b> Together.ai, Fireworks.ai</li>
                                    <li><b>Best for monitoring/tracking:</b> Helicone, PromptLayer</li>
                                    <li><b>Best for orchestration & logic:</b> LangChain</li>
                                    <li><b>Best for local dev:</b> Ollama</li>
                                </ul>
                                <h2 style="font-size: 1.15rem; margin-top: 24px; margin-bottom: 10px; color: #27457c;">Use Case ‚Üí Best Tool(s) ‚Üí Highlights</h2>
                                <div class="table-responsive">
                                    <table class="table table-bordered usecase-table" style="background: #fff;">
                                        <thead class="table-light">
                                            <tr>
                                                <th>Use Case</th>
                                                <th>Best Tool(s)</th>
                                                <th>Highlights</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr><td>Commercial LLM Aggregation</td><td>üèÜ OpenRouter</td><td>Unified access to OpenAI, Anthropic, Cohere, etc.</td></tr>
                                            <tr><td>Open-Source Model Access</td><td>Together.ai, Fireworks.ai</td><td>Fast, cost-efficient access to Mixtral, LLaMA, Mistral</td></tr>
                                            <tr><td>Prompt Logging & Monitoring</td><td>Helicone, PromptLayer</td><td>Dashboards, prompt tracking, version control</td></tr>
                                            <tr><td>LLM Orchestration Logic</td><td>LangChain</td><td>Workflow control, multi-model routing, agents</td></tr>
                                            <tr><td>Local Model Running</td><td>Ollama</td><td>Run LLMs (like LLaMA2) locally via CLI/API</td></tr>
                                            <tr><td>Fast Open-Source Inference</td><td>Groq API</td><td>Lightning-fast Mixtral, low latency</td></tr>
                                            <tr><td>Custom App Integration</td><td>Vercel AI SDK</td><td>LLM abstraction with Vercel + custom backend</td></tr>
                                            <tr><td>Performance-Focused LLM APIs</td><td>Anyscale Endpoints</td><td>Optimized OpenAI-compatible APIs, from Ray team</td></tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div style="margin-top: 32px; color: #888; font-size: 0.98rem;">Want a visual diagram of these tools by category? Let us know!</div>
                                
                                <!-- Detailed Model Comparison Section -->
                                <h2 style="font-size: 1.5rem; margin-top: 48px; margin-bottom: 20px; color: #27457c; border-bottom: 2px solid #e0e0e0; padding-bottom: 10px;">üîç Detailed Free Model Comparison</h2>
                                <div class="alert alert-success mb-4" style="background: #f0f8f0; color: #27457c; border: none; border-radius: 10px;">
                                    <strong>Updated Models:</strong> This section provides a comprehensive comparison of the latest free models available on OpenRouter, including context windows, performance metrics, and use case recommendations.
                                </div>
                                
                                <!-- Model Comparison Filters -->
                                <div class="mb-4 d-flex flex-wrap align-items-center gap-3" id="model-comparison-filters">
                                    <input type="text" id="model-search" class="form-control" style="max-width: 300px;" placeholder="Search models by name, provider, or features...">
                                    <div class="d-flex flex-wrap gap-2">
                                        <span class="badge bg-primary filter-chip" data-category="high_context">High Context</span>
                                        <span class="badge bg-success filter-chip" data-category="fast_inference">Fast Inference</span>
                                        <span class="badge bg-info filter-chip" data-category="multilingual">Multilingual</span>
                                        <span class="badge bg-warning text-dark filter-chip" data-category="code_focused">Code Focused</span>
                                        <span class="badge bg-secondary filter-chip" data-category="chat_optimized">Chat Optimized</span>
                                        <span class="badge bg-danger filter-chip" data-category="experimental">Experimental</span>
                                    </div>
                                </div>
                                
                                <!-- Detailed Model Comparison Table -->
                                <div class="table-responsive mb-4">
                                    <table class="table table-bordered table-hover" id="model-comparison-table" style="background: #fff; font-size: 0.95rem;">
                                        <thead class="table-dark">
                                            <tr>
                                                <th style="min-width: 150px;">Model Name</th>
                                                <th style="min-width: 120px;">Provider</th>
                                                <th style="min-width: 100px;">Context Window</th>
                                                <th style="min-width: 100px;">Performance</th>
                                                <th style="min-width: 100px;">Model Size</th>
                                                <th style="min-width: 120px;">Best For</th>
                                                <th style="min-width: 150px;">Strengths</th>
                                                <th style="min-width: 150px;">Notes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="model-comparison-tbody">
                                            <!-- Model data will be populated by JavaScript -->
                                        </tbody>
                                    </table>
                                </div>
                                
                                <!-- Model Performance Chart -->
                                <div class="mb-4" style="background: #f8fafc; border-radius: 10px; padding: 20px; text-align: center;">
                                    <h4 style="color: #27457c; margin-bottom: 15px;">Model Performance Comparison</h4>
                                    <canvas id="model-performance-chart" width="800" height="300" style="max-width: 100%; margin-bottom: 10px;"></canvas>
                                    <div style="color: #888; font-size: 0.9rem;">Context window size vs. model performance rating</div>
                                </div>
                                
                                <!-- Model Recommendations -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <div class="card h-100" style="border: 1px solid #e0e0e0;">
                                            <div class="card-header" style="background: #f8f9fa; color: #27457c; font-weight: 600;">
                                                üèÜ Top Recommendations
                                            </div>
                                            <div class="card-body">
                                                <ul class="list-unstyled mb-0">
                                                    <li class="mb-2"><strong>Best Overall:</strong> <span class="text-primary">DeepSeek Chat V3</span> (chat-optimized)</li>
                                                    <li class="mb-2"><strong>Best for Code:</strong> <span class="text-success">Mistral Small 3.2</span> (strong reasoning)</li>
                                                    <li class="mb-2"><strong>Best for Long Context:</strong> <span class="text-info">Kimi K2</span> (200K tokens)</li>
                                                    <li class="mb-2"><strong>Fastest:</strong> <span class="text-warning">Gemma 3N</span> (2B parameters)</li>
                                                    <li class="mb-2"><strong>Most Experimental:</strong> <span class="text-danger">Quasar Alpha</span> (cutting-edge)</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card h-100" style="border: 1px solid #e0e0e0;">
                                            <div class="card-header" style="background: #f8f9fa; color: #27457c; font-weight: 600;">
                                                üìä Performance Metrics
                                            </div>
                                            <div class="card-body">
                                                <ul class="list-unstyled mb-0">
                                                    <li class="mb-2"><strong>Context Range:</strong> 8K - 200K tokens</li>
                                                    <li class="mb-2"><strong>Model Sizes:</strong> 2B - 24B+ parameters</li>
                                                    <li class="mb-2"><strong>All Models:</strong> Free tier available</li>
                                                    <li class="mb-2"><strong>API Compatibility:</strong> OpenAI-compatible</li>
                                                    <li class="mb-2"><strong>Total Models:</strong> 9 free models</li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="market-overtime-content" role="tabpanel" aria-labelledby="market-overtime-tab">
                        <div class="card shadow-sm flex-fill d-flex flex-column">
                            <div class="card-body d-flex flex-column">
                                <div class="card-header-row flex-column align-items-stretch" style="gap:0.5rem;">
                                    <div class="d-flex align-items-center">
                                        <div class="card-title" style="font-size:1.1rem;font-weight:600;color:#183153;">Market Overtime</div>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-3 how-it-works-btn" data-bs-target="#marketOvertimeHelpModal">
                                            How it works
                                        </button>
                                    </div>
                                    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                        <div id="react-stock-select"></div>
                                        <label for="stock-select" class="form-label">Select companies:</label>
                                        <select id="stock-select" class="form-select" multiple>
                                            <option value="AAPL">Apple (AAPL)</option>
                                            <option value="MSFT">Microsoft (MSFT)</option>
                                            <option value="GOOGL">Google (GOOGL)</option>
                                            <option value="AMZN">Amazon (AMZN)</option>
                                            <option value="META">Meta (META)</option>
                                            <option value="NVDA">Nvidia (NVDA)</option>
                                            <option value="TSLA">Tesla (TSLA)</option>
                                            <option value="NFLX">Netflix (NFLX)</option>
                                            <option value="AMD">AMD (AMD)</option>
                                            <option value="INTC">Intel (INTC)</option>
                                            <option value="BRK-B">Berkshire Hathaway (BRK-B)</option>
                                            <option value="JNJ">Johnson & Johnson (JNJ)</option>
                                            <option value="V">Visa (V)</option>
                                            <option value="JPM">JPMorgan Chase (JPM)</option>
                                            <option value="WMT">Walmart (WMT)</option>
                                            <option value="PG">Procter & Gamble (PG)</option>
                                            <option value="KO">Coca-Cola (KO)</option>
                                            <option value="XOM">Exxon Mobil (XOM)</option>
                                            <option value="SPY">S&P 500 ETF (SPY)</option>
                                            <option value="QQQ">Nasdaq 100 ETF (QQQ)</option>
                                            <option value="VOO">S&P 500 ETF (VOO)</option>
                                            <option value="ARKK">ARK Innovation ETF (ARKK)</option>
                                            <option value="EEM">Emerging Markets ETF (EEM)</option>
                                            <option value="XLF">Financial Select Sector SPDR (XLF)</option>
                                            <option value="ES=F">S&P 500 E-mini (ES=F)</option>
                                            <option value="NQ=F">Nasdaq 100 E-mini (NQ=F)</option>
                                            <option value="YM=F">Dow Jones E-mini (YM=F)</option>
                                            <option value="RTY=F">Russell 2000 E-mini (RTY=F)</option>
                                            <option value="MES=F">Micro E-mini S&P 500 (MES=F)</option>
                                            <option value="MNQ=F">Micro E-mini Nasdaq 100 (MNQ=F)</option>
                                            <option value="MYM=F">Micro E-mini Dow (MYM=F)</option>
                                            <option value="M2K=F">Micro E-mini Russell 2000 (M2K=F)</option>
                                            <option value="GC=F">Gold (GC=F)</option>
                                            <option value="SI=F">Silver (SI=F)</option>
                                            <option value="CL=F">Crude Oil WTI (CL=F)</option>
                                            <option value="BZ=F">Brent Oil (BZ=F)</option>
                                            <option value="NG=F">Natural Gas (NG=F)</option>
                                            <option value="HG=F">Copper (HG=F)</option>
                                            <option value="ZC=F">Corn (ZC=F)</option>
                                            <option value="ZS=F">Soybeans (ZS=F)</option>
                                            <option value="ZW=F">Wheat (ZW=F)</option>
                                            <option value="VX=F">VIX (VX=F)</option>
                                            <option value="BTC=F">Bitcoin Futures (BTC=F)</option>
                                            <option value="ETH=F">Ethereum Futures (ETH=F)</option>
                                        </select>
                                    </div>
                                    <div class="d-flex flex-wrap align-items-center gap-3 mb-2">
                                    </div>
                                    <div id="market-legend" class="mb-2" style="font-size:1rem;color:#183153;font-weight:500;"></div>
                                </div>
                                <div class="card-section-vertical">
                                    <div id="stock-trends-result" class="mb-2"></div>
                                    <div class="chart-area"><div id="d3-stock-chart"></div></div>
                                    <div class="mb-2" style="width:100%;max-width:700px;">
                                        <div id="market-slider"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="volatility-explorer-content" role="tabpanel" aria-labelledby="volatility-explorer-tab">
                        <div class="card shadow-sm flex-fill d-flex flex-column">
                            <div class="card-body d-flex flex-column">
                                <div class="card-header-row">
                                    <div class="d-flex align-items-center">
                                        <span class="card-title">üìä Enhanced Volatility Explorer</span>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-3 how-it-works-btn" data-bs-target="#volatilityExplorerHelpModal">
                                            How it works
                                        </button>
                                    </div>
                                </div>
                                <div class="card-section-vertical">
                                    <div class="mb-2" style="color:#183153;font-size:1.04rem;">
                                        <span style="font-size:1.1rem;">üìà <b>Rolling volatility</b> reveals when the stock experienced sharp price movements.</span>
                                        <br>
                                        <span style="font-size:1rem;">üéØ <b>Regime analysis</b> identifies different market conditions and volatility patterns.</span>
                                    </div>
                                    
                                    <!-- Company Selection -->
                                    <div class="d-flex flex-wrap align-items-center gap-2 mb-3">
                                        <label for="volatility-stock-select" class="form-label mb-0">Select company:</label>
                                        <select id="volatility-stock-select" class="form-select" style="max-width: 300px;">
                                            <option value="AAPL">Apple (AAPL)</option>
                                            <option value="MSFT">Microsoft (MSFT)</option>
                                            <option value="GOOGL">Google (GOOGL)</option>
                                            <option value="AMZN">Amazon (AMZN)</option>
                                            <option value="META">Meta (META)</option>
                                            <option value="NVDA">Nvidia (NVDA)</option>
                                            <option value="TSLA">Tesla (TSLA)</option>
                                            <option value="NFLX">Netflix (NFLX)</option>
                                            <option value="AMD">AMD (AMD)</option>
                                            <option value="INTC">Intel (INTC)</option>
                                            <option value="BRK-B">Berkshire Hathaway (BRK-B)</option>
                                            <option value="JNJ">Johnson & Johnson (JNJ)</option>
                                            <option value="V">Visa (V)</option>
                                            <option value="JPM">JPMorgan Chase (JPM)</option>
                                            <option value="WMT">Walmart (WMT)</option>
                                            <option value="PG">Procter & Gamble (PG)</option>
                                            <option value="KO">Coca-Cola (KO)</option>
                                            <option value="XOM">Exxon Mobil (XOM)</option>
                                            <option value="SPY">S&P 500 ETF (SPY)</option>
                                            <option value="QQQ">Nasdaq 100 ETF (QQQ)</option>
                                            <option value="VOO">S&P 500 ETF (VOO)</option>
                                            <option value="ARKK">ARK Innovation ETF (ARKK)</option>
                                            <option value="EEM">Emerging Markets ETF (EEM)</option>
                                            <option value="XLF">Financial Select Sector SPDR (XLF)</option>
                                            <option value="ES=F">S&P 500 E-mini (ES=F)</option>
                                            <option value="NQ=F">Nasdaq 100 E-mini (NQ=F)</option>
                                            <option value="YM=F">Dow Jones E-mini (YM=F)</option>
                                            <option value="RTY=F">Russell 2000 E-mini (RTY=F)</option>
                                            <option value="MES=F">Micro E-mini S&P 500 (MES=F)</option>
                                            <option value="MNQ=F">Micro E-mini Nasdaq 100 (MNQ=F)</option>
                                            <option value="MYM=F">Micro E-mini Dow (MYM=F)</option>
                                            <option value="M2K=F">Micro E-mini Russell 2000 (M2K=F)</option>
                                            <option value="GC=F">Gold (GC=F)</option>
                                            <option value="SI=F">Silver (SI=F)</option>
                                            <option value="CL=F">Crude Oil WTI (CL=F)</option>
                                            <option value="BZ=F">Brent Oil (BZ=F)</option>
                                            <option value="NG=F">Natural Gas (NG=F)</option>
                                            <option value="HG=F">Copper (HG=F)</option>
                                            <option value="ZC=F">Corn (ZC=F)</option>
                                            <option value="ZS=F">Soybeans (ZS=F)</option>
                                            <option value="ZW=F">Wheat (ZW=F)</option>
                                            <option value="VX=F">VIX (VX=F)</option>
                                            <option value="BTC=F">Bitcoin Futures (BTC=F)</option>
                                            <option value="ETH=F">Ethereum Futures (ETH=F)</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Enhanced Controls -->
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="d-flex flex-wrap align-items-center gap-2 mb-2" id="volatility-controls">
                                                <label for="vol-window" class="form-label mb-0">Rolling Window (days):</label>
                                                <input type="number" id="vol-window" class="form-control w-auto" value="30" min="1" style="max-width:80px;">
                                                <label for="vol-years" class="form-label mb-0">Time Range (years):</label>
                                                <input type="number" id="vol-years" class="form-control w-auto" value="2" min="1" style="max-width:80px;">
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
                                                <label for="regime-window" class="form-label mb-0">Regime Window (days):</label>
                                                <input type="number" id="regime-window" class="form-control w-auto" value="30" min="5" style="max-width:80px;">
                                                <button type="button" onclick="fetchAndRenderVolatilityCorrelation()" class="btn btn-dark-bbg">Analyze Volatility</button>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Chart Area -->
                                    <div class="chart-area"><div id="volatility-correlation-chart"></div></div>
                                    
                                    <!-- Slider Controls -->
                                    <div class="mb-2" style="width:100%;max-width:700px;">
                                        <div id="volatility-range-slider"></div>
                                        <div class="d-flex justify-content-between mt-1">
                                            <span id="volatility-range-start" style="font-size:0.98rem;"></span>
                                            <span id="volatility-range-end" style="font-size:0.98rem;"></span>
                                        </div>
                                    </div>
                                    
                                    <!-- Regime Analysis Results -->
                                    <div id="regime-analysis-results" class="mt-4" style="display: none;">
                                        <h6 class="mb-3">üìä Volatility Regime Analysis</h6>
                                        <div id="regime-statistics" class="row mb-3"></div>
                                        <div id="regime-periods" class="mt-3"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                    <div class="tab-pane fade" id="hf-signal-tool-content" role="tabpanel" aria-labelledby="hf-signal-tool-tab">
                        <div class="card shadow-sm flex-fill d-flex flex-column">
                            <div class="card-body d-flex flex-column">
                                <div class="card-header-row">
                                    <div class="d-flex align-items-center">
                                        <span class="card-title">Trading Strategy Analyzer</span>
                                    </div>
                                </div>
                                <div class="container py-4"><div id="react-hedge-fund-tool"></div></div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="deepseek-chatbot-content" role="tabpanel" aria-labelledby="deepseek-chatbot-tab">
                        <div id="react-deepseek-chatbot"></div>
                    </div>

                    <div class="tab-pane fade show active" id="minigolf-strategy-content" role="tabpanel" aria-labelledby="minigolf-strategy-tab">
                        <div class="card shadow-sm flex-fill d-flex flex-column" style="max-width: 1400px; margin: 0 auto; border-radius: 16px;">
                            <div class="card-body d-flex flex-column" style="padding: 32px;">
                                <div class="text-center mb-4" style="position: sticky; top: 0; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 20px 0; z-index: 100; border-bottom: 1px solid rgba(0, 0, 0, 0.1); margin: -32px -32px 30px -32px; padding-left: 32px; padding-right: 32px;">
                                    <h1 style="color: #2c3e50; font-size: 2.2rem; font-weight: 700; margin-bottom: 10px;">
                                        üèåÔ∏è Golf Factor Analysis
                                    </h1>
                                    <p style="color: #7f8c8d; font-size: 1.1rem; margin-bottom: 0;">
                                        AI-powered analysis to determine the optimal time to play golf courses across the United States
                                    </p>
                                </div>

                                <!-- State Filter Section -->
                                <div class="card mb-4" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                    <div class="card-body">
                                        <h3 style="color: #2c3e50; font-size: 1.5rem; font-weight: 600; margin-bottom: 15px;">
                                            <i class="fas fa-filter me-2"></i>Filter by Location
                                        </h3>
                                        
                                        <!-- State Filter -->
                                        <div class="row g-3 mb-4">
                                            <div class="col-md-6">
                                                <label for="stateFilter" class="form-label">Select State/Country</label>
                                                <select class="form-select" id="stateFilter">
                                                    <option value="">All Locations</option>
                                                    <option value="California">California</option>
                                                    <option value="Georgia">Georgia</option>
                                                    <option value="North Carolina">North Carolina</option>
                                                    <option value="Wisconsin">Wisconsin</option>
                                                    <option value="New York">New York</option>
                                                    <option value="Florida">Florida</option>
                                                    <option value="Pennsylvania">Pennsylvania</option>
                                                    <option value="New Jersey">New Jersey</option>
                                                    <option value="Michigan">Michigan</option>
                                                    <option value="Nebraska">Nebraska</option>
                                                    <option value="Colorado">Colorado</option>
                                                    <option value="Oregon">Oregon</option>
                                                    <option value="Texas">Texas</option>
                                                    <option value="Arizona">Arizona</option>
                                                    <option value="Nevada">Nevada</option>
                                                    <option value="Hawaii">Hawaii</option>
                                                    <option value="Scotland">Scotland</option>
                                                    <option value="England">England</option>
                                                    <option value="Ireland">Ireland</option>
                                                    <option value="Australia">Australia</option>
                                                    <option value="Japan">Japan</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="targetDate" class="form-label">Target Date</label>
                                                <input type="date" class="form-control" id="targetDate">
                                            </div>
                                        </div>
                                        
                                        <div class="alert alert-info">
                                            <i class="fas fa-info-circle me-2"></i>
                                            Select a location to see the top golf course recommendations for that area.
                                        </div>
                                    </div>
                                </div>

                                <!-- Course Analysis Section -->
                                <div id="courseAnalysis" class="mb-4" style="display: none;">
                                    <div class="row">
                                        <!-- Course Details -->
                                        <div class="col-lg-8">
                                            <div class="card" style="border-left: 5px solid #7fb069; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                                <div class="card-header" style="background: linear-gradient(135deg, #7fb069, #2a9d8f); color: white; border-radius: 12px 12px 0 0;">
                                                    <h3 class="mb-0" id="selectedCourseName">
                                                        <i class="fas fa-golf-ball-tee me-2"></i>Course Analysis
                                                    </h3>
                                                </div>
                                                <div class="card-body">
                                                    <!-- Factor Analysis -->
                                                    <div class="mb-4">
                                                        <h5>Factor Analysis</h5>
                                                        <div id="factorAnalysis">
                                                            <!-- Factor items will be populated here -->
                                                        </div>
                                                    </div>

                                                    <!-- Weather Information -->
                                                    <div class="mb-4">
                                                        <h5>Current Weather</h5>
                                                        <div id="weatherInfo">
                                                            <!-- Weather info will be populated here -->
                                                        </div>
                                                    </div>

                                                    <!-- AI Recommendation -->
                                                    <div class="card" style="background: linear-gradient(135deg, #e8f5e8, #f0f8f0); border: 2px solid #7fb069;">
                                                        <div class="card-body">
                                                            <h5 class="card-title">
                                                                <i class="fas fa-robot me-2"></i>AI Recommendation
                                                            </h5>
                                                            <p class="card-text" id="aiRecommendation">
                                                                <!-- AI recommendation will be populated here -->
                                                            </p>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Clothing & Equipment Recommendation -->
                                                    <div class="card mt-3" style="background: linear-gradient(135deg, #fff3cd, #ffeaa7); border: 2px solid #f39c12;">
                                                        <div class="card-body">
                                                            <h5 class="card-title">
                                                                <i class="fas fa-tshirt me-2"></i>What to Wear
                                                            </h5>
                                                            <div id="clothingRecommendation" style="white-space: pre-line; font-size: 0.9rem;">
                                                                <!-- Clothing recommendation will be populated here -->
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Timing Grade & Summary -->
                                        <div class="col-lg-4">
                                            <div class="card" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                                <div class="card-header text-center" style="background: linear-gradient(135deg, #2c5530, #4a7c59); color: white;">
                                                    <h4 class="mb-0">Timing Grade</h4>
                                                </div>
                                                <div class="card-body text-center">
                                                    <div class="timing-grade" id="timingGrade" style="font-size: 3rem; font-weight: 900; margin: 1rem 0;">-</div>
                                                    <div class="score-badge" id="overallScore" style="display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; font-size: 1.1rem;">0/100</div>
                                                    <p class="mt-3 text-muted" id="gradeExplanation">
                                                        <!-- Grade explanation will be populated here -->
                                                    </p>
                                                </div>
                                            </div>

                                            <!-- Quick Actions -->
                                            <div class="card mt-3" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                                <div class="card-header">
                                                    <h5 class="mb-0">Quick Actions</h5>
                                                </div>
                                                <div class="card-body">
                                                    <button class="btn btn-outline-primary w-100 mb-2" onclick="getWeatherForecast()" style="border: 2px solid #2c5530; color: #2c5530; border-radius: 25px; padding: 0.5rem 1.5rem; font-weight: 600;">
                                                        <i class="fas fa-cloud-sun me-2"></i>5-Day Forecast
                                                    </button>
                                                    <button class="btn btn-outline-primary w-100 mb-2" onclick="analyzeDifferentDate()" style="border: 2px solid #2c5530; color: #2c5530; border-radius: 25px; padding: 0.5rem 1.5rem; font-weight: 600;">
                                                        <i class="fas fa-calendar me-2"></i>Different Date
                                                    </button>
                                                    <button class="btn btn-outline-primary w-100" onclick="shareAnalysis()" style="border: 2px solid #2c5530; color: #2c5530; border-radius: 25px; padding: 0.5rem 1.5rem; font-weight: 600;">
                                                        <i class="fas fa-share me-2"></i>Share Analysis
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Top Recommendations Section -->
                                <div class="card mb-4" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                    <div class="card-header" style="background: linear-gradient(135deg, #2c5530, #4a7c59); color: white;">
                                        <h3 class="mb-0">
                                            <i class="fas fa-star me-2"></i>Top Recommendations
                                        </h3>
                                    </div>
                                    <div class="card-body">
                                        <div class="text-center" id="recommendationsLoading" style="display: none;">
                                            <div class="loading-timer-container">
                                                <div class="spinner-border text-primary mb-3" role="status">
                                                    <span class="visually-hidden">Loading recommendations...</span>
                                                </div>
                                                <div class="loading-progress mb-2">
                                                    <div class="progress" style="height: 8px; border-radius: 10px;">
                                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                                             role="progressbar" 
                                                             id="recommendationsProgress" 
                                                             style="width: 0%; background: linear-gradient(45deg, #007bff, #0056b3);">
                                                        </div>
                                                    </div>
                                                </div>
                                                <p class="loading-text mb-1">Loading top recommendations...</p>
                                                <small class="text-muted" id="recommendationsTimer">Starting analysis...</small>
                                            </div>
                                        </div>
                                        <div id="recommendationsList">
                                            <!-- Recommendations will be populated here -->
                                        </div>
                                    </div>
                                </div>

                                <!-- Weather Forecast Section -->
                                <div id="weatherForecast" class="mb-4" style="display: none;">
                                    <div class="card" style="border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                                        <div class="card-header" style="background: linear-gradient(135deg, #2c5530, #4a7c59); color: white;">
                                            <h3 class="mb-0">
                                                <i class="fas fa-cloud-sun me-2"></i>5-Day Weather Forecast
                                            </h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="row" id="forecastContainer">
                                                <!-- Forecast items will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="event-analysis-content" role="tabpanel" aria-labelledby="event-analysis-tab">
                        <div class="card shadow-sm flex-fill d-flex flex-column" style="max-width: 1400px; margin: 0 auto; border-radius: 16px;">
                            <div class="card-body d-flex flex-column" style="padding: 32px;">
                        <div id="futurequant-dashboard-root">
                            <!-- FutureQuant Dashboard Header -->
                            <div class="card shadow-sm mb-4">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-8">
                                            <h2 class="mb-2">
                                                <i class="fas fa-chart-line text-primary"></i> 
                                                FutureQuant Trader Dashboard
                                            </h2>
                                            <p class="text-muted mb-0">Distributional Futures Trading Platform - Research, Backtesting & Paper Trading</p>
                                            
                                            <!-- Quick Start Guide -->
                                            <div class="alert alert-info mt-3 mb-0">
                                                <h6><i class="fas fa-info-circle"></i> Quick Start Guide:</h6>
                                                <ol class="mb-0 small">
                                                    <li><strong>Select a Symbol</strong> (e.g., ES for S&P 500 futures)</li>
                                                    <li><strong>Choose a Strategy</strong> based on your risk tolerance</li>
                                                    <li><strong>View Charts</strong> to analyze market data</li>
                                                    <li><strong>Train Models</strong> or run backtests to test strategies</li>
                                                </ol>
                                            </div>
                                        </div>
                                        <div class="col-md-4 text-end">
                                            <div class="d-flex gap-2 justify-content-end">
                                                <button class="btn btn-outline-primary btn-sm" id="fq-ingest-data-btn">
                                                    <i class="fas fa-download"></i> Ingest Data
                                                </button>
                                                <button class="btn btn-outline-success btn-sm" id="fq-compute-features-btn">
                                                    <i class="fas fa-cogs"></i> Compute Features
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Market Overview Section -->
                            <div class="row mb-4">
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="card-title text-muted">Current Price</h6>
                                            <h3 class="text-primary" id="fq-current-price">$0.00</h3>
                                            <small class="text-muted" id="fq-price-change">+0.00 (0.00%)</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="card-title text-muted">Volume</h6>
                                            <h3 class="text-info" id="fq-volume">0</h3>
                                            <small class="text-muted">Contracts</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="card-title text-muted">Strategy</h6>
                                            <select class="form-select form-select-sm" id="fq-strategy-select">
                                                <option value="">Select Strategy</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="card text-center">
                                        <div class="card-body">
                                            <h6 class="card-title text-muted">Symbol</h6>
                                            <select class="form-select form-select-sm" id="fq-symbol-select">
                                                <option value="">Select Symbol</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Price Chart and Distribution Cards -->
                            <div class="row mb-4">
                                <div class="col-md-8">
                                    <div class="card">
                                        <div class="card-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0"><i class="fas fa-chart-line text-primary"></i> Price Chart</h6>
                                                <div>
                                                    <select class="form-select form-select-sm me-2" id="chart-timeframe" style="width: auto;">
                                                        <option value="1d">1 Day</option>
                                                        <option value="1h">1 Hour</option>
                                                        <option value="15m">15 Min</option>
                                                        <option value="5m">5 Min</option>
                                                    </select>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="loadChartData()">
                                                        <i class="fas fa-sync-alt"></i> Refresh
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="price-chart" height="300" style="max-height: 300px; width: 100%;"></canvas>
                                            <div id="chart-loading" class="text-center mt-3" style="display: none;">
                                                <div class="spinner-border text-primary" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Loading chart data...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <h6 class="mb-0"><i class="fas fa-chart-bar text-success"></i> Distribution</h6>
                                                <button class="btn btn-sm btn-outline-success" onclick="loadDistributionData()">
                                                    <i class="fas fa-sync-alt"></i> Refresh
                                                </button>
                                            </div>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="distribution-chart" height="300" style="max-height: 300px; width: 100%;"></canvas>
                                            <div id="distribution-loading" class="text-center mt-3" style="display: none;">
                                                <div class="spinner-border text-success" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </div>
                                                <p class="mt-2 text-muted">Loading distribution data...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Trading Controls Section -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Model Training</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-primary" id="fq-train-model-btn">
                                                    <i class="fas fa-rocket"></i> Train & Trade
                                                </button>
                                                <button class="btn btn-outline-primary" id="fq-backtest-btn">
                                                    <i class="fas fa-chart-bar"></i> Run Backtest
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="testModalCreation()">
                                                    Test Modal
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="testModelTraining()">
                                                    Test Training
                                                </button>
                                                <button class="btn btn-outline-secondary btn-sm" onclick="testStrategyLoading()">
                                                    Test Strategy
                                                </button>
                                            </div>
                                            <div id="fq-model-types" class="row mt-3">
                                                <!-- Model types will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="card-title mb-0">Paper Trading</h6>
                                        </div>
                                        <div class="card-body">
                                            <div class="d-grid gap-2">
                                                <button class="btn btn-success" id="fq-start-paper-trading-btn">
                                                    <i class="fas fa-rocket"></i> Train & Trade
                                                </button>
                                                <button class="btn btn-danger" id="fq-stop-paper-trading-btn">
                                                    <i class="fas fa-stop"></i> Stop Session
                                                </button>
                                                <a href="paper-trading-dashboard.html" class="btn btn-primary" target="_blank">
                                                    <i class="fas fa-chart-line"></i> Live Dashboard
                                                </a>
                                            </div>
                                            <div id="fq-paper-trading-sessions" class="row mt-3">
                                                <!-- Active sessions will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Performance & Analysis Section -->
                            <div class="row mb-4">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Performance Chart</h6>
                                        </div>
                                        <div class="card-body">
                                            <canvas id="fq-performance-chart" height="250" style="max-height: 250px; width: 100%;"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Strategy Details</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="fq-strategy-details">
                                                <p class="text-muted">Select a strategy to view details</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Recent Activity Section -->
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Recent Signals</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="fq-recent-signals">
                                                <!-- Recent signals will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Job Status</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="fq-job-statuses">
                                                <!-- Job statuses will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card">
                                        <div class="card-header">
                                            <h6 class="mb-0">Backtest Config</h6>
                                        </div>
                                        <div class="card-body">
                                            <div id="fq-backtest-config">
                                                <!-- Backtest configuration will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>



                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Container for Notifications -->
    <div id="toast-container" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1055;">
        <!-- Toast notifications will be dynamically added here -->
    </div>
    
    <!-- Market Overtime Help Modal -->
    <div class="modal fade" id="marketOvertimeHelpModal" tabindex="-1" aria-labelledby="marketOvertimeHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="marketOvertimeHelpModalLabel">How Market Overtime Works</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This tool fetches and visualizes historical stock price data to help you analyze market trends over time.</p>
                    <ol>
                        <li><strong>Select Companies:</strong> Choose one or more companies from the dropdown menu. The chart will automatically update to show their stock price trends. You can select up to 10 companies to compare.</li>
                        <li><strong>Interactive Chart:</strong> The main chart displays the closing stock prices for the selected companies over the last three years. You can hover your mouse over the lines to see the exact price for a specific date.</li>
                        <li><strong>Zoom and Pan:</strong> Use the slider below the chart to zoom in on a specific time period. Drag the handles to adjust the start and end dates of your analysis.</li>
                    </ol>
                    <p class="text-muted small">All stock data is sourced from Yahoo Finance via yfinance.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Volatility Explorer Help Modal -->
    <div class="modal fade" id="volatilityExplorerHelpModal" tabindex="-1" aria-labelledby="volatilityExplorerHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="volatilityExplorerHelpModalLabel">How Enhanced Volatility Explorer Works</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This enhanced tool combines rolling volatility analysis with regime detection to provide comprehensive market risk insights.</p>
                    <ol>
                        <li><strong>Rolling Volatility:</strong> Set the number of days for calculating rolling volatility. A larger window (e.g., 30 days) shows longer-term trends, while a smaller window (e.g., 10 days) reveals short-term fluctuations.</li>
                        <li><strong>Time Range:</strong> Choose how many years of historical data to analyze. More data provides better context for volatility patterns.</li>
                        <li><strong>Regime Window:</strong> Set the window size for regime detection. This determines how volatility is classified into different market conditions.</li>
                        <li><strong>Interactive Visualization:</strong> The chart shows rolling volatility over time with highlighted periods of interest.</li>
                        <li><strong>Regime Analysis:</strong> Automatically identifies and analyzes different volatility regimes (Low, Medium, High, Extreme) with detailed statistics.</li>
                        <li><strong>Zoom Control:</strong> Use the slider below the chart to focus on specific time periods and examine volatility patterns in detail.</li>
                    </ol>
                    <p class="text-muted small">Volatility is calculated using the standard deviation of daily returns. Regime analysis helps identify market stress periods and optimal trading conditions.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>





    <!-- Trading Strategy Analyzer Help Modal -->
    <div class="modal fade" id="tradingStrategyHelpModal" tabindex="-1" aria-labelledby="tradingStrategyHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tradingStrategyHelpModalLabel">How Trading Strategy Analyzer Works</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This tool backtests trading strategies using historical data to evaluate their performance and risk metrics.</p>
                    <ol>
                        <li><strong>Strategy Parameters:</strong> Configure your trading strategy by setting entry/exit conditions, position sizing, and risk management rules.</li>
                        <li><strong>Historical Backtesting:</strong> The tool simulates your strategy on historical market data to see how it would have performed.</li>
                        <li><strong>Performance Metrics:</strong> View key metrics including total return, Sharpe ratio, maximum drawdown, and win rate.</li>
                        <li><strong>Risk Analysis:</strong> Understand the risk profile of your strategy with detailed risk metrics and performance breakdowns.</li>
                    </ol>
                    <p class="text-muted small">Backtesting results are based on historical data and may not predict future performance. Always consider market conditions and risk management.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>



    <!-- Volatility Regime Strategy Help Modal -->
    <div class="modal fade" id="volatilityRegimeHelpModal" tabindex="-1" aria-labelledby="volatilityRegimeHelpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="volatilityRegimeHelpModalLabel">How Volatility Regime Strategy Works</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>This tool analyzes market volatility regimes to help you understand different market conditions and adjust your investment strategy accordingly.</p>
                    <ol>
                        <li><strong>Select Stock:</strong> Choose a stock symbol to analyze its volatility patterns over time.</li>
                        <li><strong>Regime Detection:</strong> The tool identifies different volatility regimes: Low, Medium, High, and Extreme volatility periods.</li>
                        <li><strong>Regime Analysis:</strong> View statistics for each regime including duration, average volatility, and percentage of time spent in each regime.</li>
                        <li><strong>Strategy Insights:</strong> Understand how different market conditions affect your investment strategy and risk management.</li>
                    </ol>
                    <p class="text-muted small">Volatility regimes help identify market stress periods and can inform position sizing and risk management decisions.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/nouislider@15.7.1/dist/nouislider.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-2.26.0.min.js"></script>
    <script src="https://unpkg.com/date-fns@2.30.0/index.js"></script>
            <script src="static/main.js?v=20250117&t=1704067200&nocache=true&cb=1704067200"></script>
                        <script src="static/futurequant-dashboard.js?v=20250117&t=1704067200&nocache=true&cb=1704067200"></script>
    
    <!-- Futures Exploratorium React App -->
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Utility functions
        const formatCurrency = (value) => `$${value.toFixed(2)}`;
        const formatPercent = (value) => `${(value * 100).toFixed(2)}%`;
        const formatNumber = (value) => value.toLocaleString();
        
        // API Service
        const apiService = {
            async get(endpoint) {
                try {
                    const response = await fetch(`/api/v1${endpoint}`);
                    return await response.json();
                } catch (error) {
                    console.error(`API Error (${endpoint}):`, error);
                    return { success: false, error: error.message };
                }
            },
            async post(endpoint, data) {
                try {
                    const response = await fetch(`/api/v1${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(data)
                    });
                    return await response.json();
                } catch (error) {
                    console.error(`API Error (${endpoint}):`, error);
                    return { success: false, error: error.message };
                }
            }
        };
        
        // WebSocket Service
        class WebSocketService {
            constructor() {
                this.ws = null;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.listeners = new Map();
            }
            
            connect() {
                try {
                    // Dynamic WebSocket URL - works for both local and Railway deployment
                    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                    const wsHost = window.location.host;
                    this.ws = new WebSocket(`${wsProtocol}//${wsHost}/ws`);
                    
                    this.ws.onopen = () => {
                        console.log('WebSocket connected');
                        this.reconnectAttempts = 0;
                        this.emit('connected', true);
                    };
                    
                    this.ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        this.emit('message', data);
                    };
                    
                    this.ws.onclose = () => {
                        console.log('WebSocket disconnected');
                        this.emit('connected', false);
                        // Don't reconnect in demo mode
                        console.log('WebSocket reconnection disabled in demo mode');
                    };
                    
                    this.ws.onerror = (error) => {
                        console.error('WebSocket error:', error);
                        // Simulate connection for demo
                        this.emit('connected', false);
                    };
                } catch (error) {
                    console.error('WebSocket connection failed:', error);
                    // Simulate connection for demo
                    this.emit('connected', false);
                }
            }
            
            reconnect() {
                if (this.reconnectAttempts < this.maxReconnectAttempts) {
                    this.reconnectAttempts++;
                    setTimeout(() => this.connect(), 2000 * this.reconnectAttempts);
                }
            }
            
            subscribe(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, []);
                }
                this.listeners.get(event).push(callback);
                
                return () => {
                    const callbacks = this.listeners.get(event);
                    if (callbacks) {
                        const index = callbacks.indexOf(callback);
                        if (index > -1) callbacks.splice(index, 1);
                    }
                };
            }
            
            emit(event, data) {
                const callbacks = this.listeners.get(event);
                if (callbacks) {
                    callbacks.forEach(callback => callback(data));
                }
            }
            
            disconnect() {
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
            }
        }
        
        const wsService = new WebSocketService();
        
        // Store (Zustand-like state management)
        const createStore = (initialState) => {
            let state = { ...initialState };
            const listeners = new Set();
            
            return {
                getState: () => state,
                setState: (newState) => {
                    state = { ...state, ...newState };
                    listeners.forEach(listener => listener(state));
                },
                subscribe: (listener) => {
                    listeners.add(listener);
                    return () => listeners.delete(listener);
                }
            };
        };
        
        const store = createStore({
            systemHealth: { status: 'unknown', score: 0, uptime: 0, lastUpdate: null },
            marketData: {
                ES: { price: 4250.50, change: 12.50, changePercent: 0.0029, volume: 1500000, sparkline: [] },
                NQ: { price: 14500.25, change: -25.75, changePercent: -0.0018, volume: 800000, sparkline: [] },
                RTY: { price: 1850.75, change: 8.25, changePercent: 0.0045, volume: 450000, sparkline: [] }
            },
            strategyPerformance: {
                pnl: 1250.75,
                sharpe: 1.85,
                drawdown: -0.08,
                winRate: 0.68,
                equityCurve: [],
                isRunningBacktest: false
            },
            isConnected: false,
            lastUpdate: new Date()
        });
        
        // Header Component
        const Header = () => {
            const [state, setState] = useState(store.getState());
            
            useEffect(() => {
                const unsubscribe = store.subscribe(setState);
                return unsubscribe;
            }, []);
            
            const getHealthColor = (status) => {
                switch (status) {
                    case 'healthy': return '#00ff88';
                    case 'warning': return '#ffaa00';
                    case 'error': return '#ff4444';
                    default: return '#666666';
                }
            };
            
            return (
                <div style={{
                    background: 'linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%)',
                    padding: '1rem 2rem',
                    marginBottom: '2rem',
                    borderRadius: '12px',
                    boxShadow: '0 4px 20px rgba(0, 0, 0, 0.3)',
                    border: '1px solid #333'
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <h1 style={{ 
                                margin: 0, 
                                fontSize: '2rem', 
                                fontWeight: '700',
                                background: 'linear-gradient(135deg, #00d4ff 0%, #ff6b35 100%)',
                                WebkitBackgroundClip: 'text',
                                WebkitTextFillColor: 'transparent',
                                backgroundClip: 'text'
                            }}>
                                Futures Exploratorium
                            </h1>
                            <p style={{ margin: '0.5rem 0 0 0', color: '#888', fontSize: '0.9rem' }}>
                                Experimental Trading Platform
                                <span style={{ 
                                    marginLeft: '1rem', 
                                    padding: '0.25rem 0.5rem', 
                                    background: 'rgba(0, 212, 255, 0.2)', 
                                    borderRadius: '4px',
                                    fontSize: '0.8rem',
                                    color: '#00d4ff'
                                }}>
                                    DEMO MODE
                                </span>
                            </p>
                        </div>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '1rem' }}>
                            <div style={{ textAlign: 'right' }}>
                                <div style={{ 
                                    color: getHealthColor(state.systemHealth.status),
                                    fontSize: '0.9rem',
                                    fontWeight: '500'
                                }}>
                                    System: {state.systemHealth.status.toUpperCase()}
                                </div>
                                <div style={{ color: '#888', fontSize: '0.8rem' }}>
                                    Score: {(state.systemHealth.score * 100).toFixed(0)}%
                                </div>
                            </div>
                            <div style={{
                                width: '12px',
                                height: '12px',
                                borderRadius: '50%',
                                backgroundColor: state.isConnected ? '#00ff88' : '#ff4444',
                                boxShadow: state.isConnected ? '0 0 10px #00ff88' : '0 0 10px #ff4444'
                            }} />
                        </div>
                    </div>
                </div>
            );
        };
        
        // Market Overview Component
        const MarketOverview = () => {
            const [state, setState] = useState(store.getState());
            const [expandedSymbol, setExpandedSymbol] = useState(null);
            const [isAnimating, setIsAnimating] = useState(false);
            
            useEffect(() => {
                const unsubscribe = store.subscribe(setState);
                return unsubscribe;
            }, []);
            
            // Animation effect when market data changes
            useEffect(() => {
                setIsAnimating(true);
                const timer = setTimeout(() => setIsAnimating(false), 1000);
                return () => clearTimeout(timer);
            }, [state.marketData.ES.price, state.marketData.NQ.price, state.marketData.RTY.price]);
            
            const symbols = ['ES', 'NQ', 'RTY'];
            
            const Sparkline = ({ data, color, isAnimating }) => {
                if (!data || data.length < 2) return null;
                
                const width = 80;
                const height = 30;
                const min = Math.min(...data);
                const max = Math.max(...data);
                const range = max - min || 1;
                
                const points = data.map((value, index) => {
                    const x = (index / (data.length - 1)) * width;
                    const y = height - ((value - min) / range) * height;
                    return `${x},${y}`;
                }).join(' ');
                
                return (
                    <svg width={width} height={height} style={{ marginLeft: '0.5rem' }}>
                        <polyline
                            points={points}
                            fill="none"
                            stroke={color}
                            strokeWidth="2"
                            strokeDasharray={isAnimating ? "1000" : "none"}
                            strokeDashoffset={isAnimating ? "1000" : "0"}
                            style={{
                                animation: isAnimating ? 'sparklineDraw 1.5s ease-out forwards' : 'none',
                                transition: 'all 0.3s ease'
                            }}
                        />
                    </svg>
                );
            };
            
            return (
                <div style={{
                    background: 'linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%)',
                    padding: '1.5rem',
                    borderRadius: '12px',
                    boxShadow: isAnimating ? '0 4px 30px rgba(0, 212, 255, 0.3)' : '0 4px 20px rgba(0, 0, 0, 0.3)',
                    border: isAnimating ? '1px solid #00d4ff' : '1px solid #333',
                    transition: 'all 0.3s ease',
                    animation: isAnimating ? 'glow 1s ease-in-out' : 'none'
                }}>
                    <h3 style={{ 
                        margin: '0 0 1.5rem 0', 
                        color: '#fff',
                        fontSize: '1.2rem',
                        fontWeight: '600',
                        animation: isAnimating ? 'slideInUp 0.6s ease-out' : 'none'
                    }}>
                        Market Overview
                    </h3>
                    <div style={{ display: 'grid', gap: '1rem' }}>
                        {symbols.map((symbol, index) => {
                            const data = state.marketData[symbol];
                            const isPositive = data.change >= 0;
                            const changeColor = isPositive ? '#00ff88' : '#ff4444';
                            
                            return (
                                <div key={symbol} style={{
                                    background: isAnimating ? 'rgba(0, 212, 255, 0.05)' : 'rgba(255, 255, 255, 0.05)',
                                    padding: '1rem',
                                    borderRadius: '8px',
                                    border: isAnimating ? '1px solid rgba(0, 212, 255, 0.3)' : '1px solid #333',
                                    cursor: 'pointer',
                                    transition: 'all 0.3s ease',
                                    animation: isAnimating ? `priceUpdate 1s ease-out ${index * 0.1}s` : 'none',
                                    transform: isAnimating ? 'scale(1.02)' : 'scale(1)',
                                    ':hover': { 
                                        background: 'rgba(255, 255, 255, 0.1)',
                                        transform: 'scale(1.02)'
                                    }
                                }}
                                onClick={() => setExpandedSymbol(expandedSymbol === symbol ? null : symbol)}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <div>
                                            <div style={{ 
                                                fontSize: '1.1rem', 
                                                fontWeight: '600', 
                                                color: '#fff',
                                                marginBottom: '0.25rem'
                                            }}>
                                                {symbol}
                                            </div>
                                            <div style={{ 
                                                fontSize: '1.5rem', 
                                                fontWeight: '700', 
                                                color: '#fff',
                                                marginBottom: '0.25rem',
                                                animation: isAnimating ? 'priceFlash 0.8s ease-out' : 'none',
                                                transition: 'all 0.3s ease'
                                            }}>
                                                {formatCurrency(data.price)}
                                            </div>
                                            <div style={{ 
                                                color: changeColor, 
                                                fontSize: '0.9rem',
                                                fontWeight: '500',
                                                animation: isAnimating ? 'numberChange 0.8s ease-out 0.2s' : 'none',
                                                transition: 'all 0.3s ease'
                                            }}>
                                                {isPositive ? '+' : ''}{formatCurrency(data.change)} ({formatPercent(data.changePercent)})
                                            </div>
                                        </div>
                                        <div style={{ display: 'flex', alignItems: 'center' }}>
                                            <Sparkline data={data.sparkline} color={changeColor} isAnimating={isAnimating} />
                                        </div>
                                    </div>
                                    <div style={{ 
                                        marginTop: '0.5rem', 
                                        fontSize: '0.8rem', 
                                        color: '#888',
                                        animation: isAnimating ? 'fadeInScale 0.6s ease-out 0.4s both' : 'none',
                                        transition: 'all 0.3s ease'
                                    }}>
                                        Vol: {formatNumber(data.volume)}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        // Equity Curve Chart Component
        const EquityCurveChart = ({ data, isAnimating }) => {
            const chartRef = useRef(null);
            
            useEffect(() => {
                if (!chartRef.current) return;
                
                // Clear previous chart
                d3.select(chartRef.current).selectAll("*").remove();
                
                // Generate sample data if none provided
                const chartData = data && data.length > 0 ? data : generateSampleEquityCurve();
                
                const margin = { top: 20, right: 30, bottom: 30, left: 40 };
                const width = 400 - margin.left - margin.right;
                const height = 160 - margin.top - margin.bottom;
                
                const svg = d3.select(chartRef.current)
                    .append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom);
                
                const g = svg.append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
                
                // Scales
                const xScale = d3.scaleLinear()
                    .domain([0, chartData.length - 1])
                    .range([0, width]);
                
                const yScale = d3.scaleLinear()
                    .domain(d3.extent(chartData))
                    .range([height, 0]);
                
                // Line generator
                const line = d3.line()
                    .x((d, i) => xScale(i))
                    .y(d => yScale(d))
                    .curve(d3.curveMonotoneX);
                
                // Area generator
                const area = d3.area()
                    .x((d, i) => xScale(i))
                    .y0(height)
                    .y1(d => yScale(d))
                    .curve(d3.curveMonotoneX);
                
                // Add gradient
                const gradient = svg.append("defs")
                    .append("linearGradient")
                    .attr("id", "equityGradient")
                    .attr("gradientUnits", "userSpaceOnUse")
                    .attr("x1", 0).attr("y1", height)
                    .attr("x2", 0).attr("y2", 0);
                
                gradient.append("stop")
                    .attr("offset", "0%")
                    .attr("stop-color", "rgba(0, 212, 255, 0.3)");
                
                gradient.append("stop")
                    .attr("offset", "100%")
                    .attr("stop-color", "rgba(0, 212, 255, 0.05)");
                
                // Add area
                g.append("path")
                    .datum(chartData)
                    .attr("fill", "url(#equityGradient)")
                    .attr("d", area)
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .style("opacity", 1);
                
                // Add line
                g.append("path")
                    .datum(chartData)
                    .attr("fill", "none")
                    .attr("stroke", "#00d4ff")
                    .attr("stroke-width", 2)
                    .attr("d", line)
                    .style("opacity", 0)
                    .transition()
                    .duration(1000)
                    .delay(500)
                    .style("opacity", 1);
                
                // Add dots for data points
                g.selectAll(".dot")
                    .data(chartData)
                    .enter().append("circle")
                    .attr("class", "dot")
                    .attr("cx", (d, i) => xScale(i))
                    .attr("cy", d => yScale(d))
                    .attr("r", 3)
                    .attr("fill", "#00d4ff")
                    .style("opacity", 0)
                    .transition()
                    .duration(200)
                    .delay((d, i) => i * 50)
                    .style("opacity", 0.8);
                
                // Add axes
                const xAxis = d3.axisBottom(xScale)
                    .ticks(5)
                    .tickFormat(d => `Day ${d + 1}`);
                
                const yAxis = d3.axisLeft(yScale)
                    .ticks(5)
                    .tickFormat(d => `$${d.toFixed(0)}`);
                
                g.append("g")
                    .attr("class", "x axis")
                    .attr("transform", `translate(0,${height})`)
                    .call(xAxis)
                    .style("color", "#888")
                    .style("font-size", "10px");
                
                g.append("g")
                    .attr("class", "y axis")
                    .call(yAxis)
                    .style("color", "#888")
                    .style("font-size", "10px");
                
                // Add grid lines
                g.append("g")
                    .attr("class", "grid")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(xScale)
                        .ticks(5)
                        .tickSize(-height)
                        .tickFormat(""))
                    .style("color", "#333")
                    .style("opacity", 0.3);
                
                g.append("g")
                    .attr("class", "grid")
                    .call(d3.axisLeft(yScale)
                        .ticks(5)
                        .tickSize(-width)
                        .tickFormat(""))
                    .style("color", "#333")
                    .style("opacity", 0.3);
                
            }, [data, isAnimating]);
            
            return <div ref={chartRef} style={{ width: '100%', height: '100%' }} />;
        };
        
        // Helper function to generate sample equity curve data
        const generateSampleEquityCurve = () => {
            const data = [];
            let value = 100000; // Starting value
            const days = 30;
            
            for (let i = 0; i < days; i++) {
                // Add some random walk with slight upward bias
                const change = (Math.random() - 0.4) * 2000; // Slight positive bias
                value += change;
                data.push(Math.max(value, 50000)); // Minimum value
            }
            
            return data;
        };
        
        // Strategy Performance Component
        const StrategyPerformance = () => {
            const [state, setState] = useState(store.getState());
            const [isAnimating, setIsAnimating] = useState(false);
            
            useEffect(() => {
                const unsubscribe = store.subscribe(setState);
                return unsubscribe;
            }, []);
            
            // Animation effect when performance data changes
            useEffect(() => {
                setIsAnimating(true);
                const timer = setTimeout(() => setIsAnimating(false), 1000);
                return () => clearTimeout(timer);
            }, [state.strategyPerformance.pnl, state.strategyPerformance.sharpe, state.strategyPerformance.drawdown, state.strategyPerformance.winRate]);
            
            const runBacktest = async () => {
                store.setState({ 
                    strategyPerformance: { 
                        ...state.strategyPerformance, 
                        isRunningBacktest: true 
                    } 
                });
                
                try {
                    // Demo mode: Use mock data directly without API calls
                    console.log('Demo mode: Using mock backtest data');
                    
                    // Add a small delay to simulate processing
                    await new Promise(resolve => setTimeout(resolve, 2000));
                    
                    const backtestResult = {
                        success: true,
                        performance: {
                            total_return: Math.random() * 5000 - 1000, // Random PnL between -1000 and 4000
                            sharpe_ratio: 1.2 + Math.random() * 1.0, // Random Sharpe between 1.2 and 2.2
                            max_drawdown: -0.05 - Math.random() * 0.1, // Random drawdown between -5% and -15%
                            win_rate: 0.6 + Math.random() * 0.2, // Random win rate between 60% and 80%
                            equity_curve: generateSampleEquityCurve()
                        }
                    };
                    
                    if (backtestResult.success) {
                        // Update with backtest results
                        store.setState({
                            strategyPerformance: {
                                ...state.strategyPerformance,
                                pnl: backtestResult.performance?.total_return || 1250.75,
                                sharpe: backtestResult.performance?.sharpe_ratio || 1.85,
                                drawdown: backtestResult.performance?.max_drawdown || -0.08,
                                winRate: backtestResult.performance?.win_rate || 0.68,
                                equityCurve: backtestResult.performance?.equity_curve || [],
                                isRunningBacktest: false
                            }
                        });
                        
                        // Add success alert
                        store.setState(prevState => ({
                            alerts: [{
                                id: Date.now() + Math.random(),
                                type: 'backtest_success',
                                level: 'info',
                                message: `Backtest completed successfully. PnL: ${formatCurrency(backtestResult.performance?.total_return || 0)}`,
                                timestamp: new Date(),
                                symbol: 'ALL'
                            }, ...prevState.alerts.slice(0, 49)]
                        }));
                    } else {
                        throw new Error(backtestResult.error || 'Backtest failed');
                    }
                } catch (error) {
                    console.error('Backtest failed:', error);
                    store.setState({ 
                        strategyPerformance: { 
                            ...state.strategyPerformance, 
                            isRunningBacktest: false 
                        } 
                    });
                    
                    // Add error alert
                    store.setState(prevState => ({
                        alerts: [{
                            id: Date.now() + Math.random(),
                            type: 'backtest_error',
                            level: 'error',
                            message: `Backtest failed: ${error.message}`,
                            timestamp: new Date(),
                            symbol: 'ALL'
                        }, ...prevState.alerts.slice(0, 49)]
                    }));
                }
            };
            
            return (
                <div style={{
                    background: 'linear-gradient(135deg, #1a1a1a 0%, #2a2a2a 100%)',
                    padding: '1.5rem',
                    borderRadius: '12px',
                    boxShadow: isAnimating ? '0 4px 30px rgba(0, 212, 255, 0.3)' : '0 4px 20px rgba(0, 0, 0, 0.3)',
                    border: isAnimating ? '1px solid #00d4ff' : '1px solid #333',
                    transition: 'all 0.3s ease',
                    animation: isAnimating ? 'glow 1s ease-in-out' : 'none'
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '1.5rem' }}>
                        <h3 style={{ 
                            margin: 0, 
                            color: '#fff',
                            fontSize: '1.2rem',
                            fontWeight: '600',
                            animation: isAnimating ? 'slideInUp 0.6s ease-out' : 'none'
                        }}>
                            Strategy Performance
                        </h3>
                        <button
                            onClick={runBacktest}
                            disabled={state.strategyPerformance.isRunningBacktest}
                            style={{
                                background: state.strategyPerformance.isRunningBacktest 
                                    ? '#666' 
                                    : 'linear-gradient(135deg, #00d4ff 0%, #ff6b35 100%)',
                                color: '#fff',
                                border: 'none',
                                padding: '0.5rem 1rem',
                                borderRadius: '6px',
                                cursor: state.strategyPerformance.isRunningBacktest ? 'not-allowed' : 'pointer',
                                fontWeight: '500',
                                fontSize: '0.9rem',
                                transition: 'all 0.3s ease',
                                transform: state.strategyPerformance.isRunningBacktest ? 'scale(0.95)' : 'scale(1)',
                                animation: state.strategyPerformance.isRunningBacktest ? 'pulse 1s infinite' : 'none',
                                boxShadow: state.strategyPerformance.isRunningBacktest ? 'none' : '0 2px 10px rgba(0, 212, 255, 0.3)'
                            }}
                        >
                            {state.strategyPerformance.isRunningBacktest ? 'Running...' : 'Run Backtest'}
                        </button>
                    </div>
                    
                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '1rem', marginBottom: '1.5rem' }}>
                        <div style={{ 
                            textAlign: 'center',
                            animation: isAnimating ? 'slideInUp 0.6s ease-out 0.1s both' : 'none'
                        }}>
                            <div style={{ color: '#888', fontSize: '0.9rem', marginBottom: '0.25rem' }}>PnL</div>
                            <div style={{ 
                                color: state.strategyPerformance.pnl >= 0 ? '#00ff88' : '#ff4444',
                                fontSize: '1.5rem',
                                fontWeight: '700',
                                animation: isAnimating ? 'numberChange 0.8s ease-out' : 'none',
                                transition: 'all 0.3s ease'
                            }}>
                                {formatCurrency(state.strategyPerformance.pnl)}
                            </div>
                        </div>
                        <div style={{ 
                            textAlign: 'center',
                            animation: isAnimating ? 'slideInUp 0.6s ease-out 0.2s both' : 'none'
                        }}>
                            <div style={{ color: '#888', fontSize: '0.9rem', marginBottom: '0.25rem' }}>Sharpe</div>
                            <div style={{ 
                                color: '#fff', 
                                fontSize: '1.5rem', 
                                fontWeight: '700',
                                animation: isAnimating ? 'numberChange 0.8s ease-out 0.1s' : 'none',
                                transition: 'all 0.3s ease'
                            }}>
                                {state.strategyPerformance.sharpe.toFixed(2)}
                            </div>
                        </div>
                        <div style={{ 
                            textAlign: 'center',
                            animation: isAnimating ? 'slideInUp 0.6s ease-out 0.3s both' : 'none'
                        }}>
                            <div style={{ color: '#888', fontSize: '0.9rem', marginBottom: '0.25rem' }}>Drawdown</div>
                            <div style={{ 
                                color: '#ff4444', 
                                fontSize: '1.5rem', 
                                fontWeight: '700',
                                animation: isAnimating ? 'numberChange 0.8s ease-out 0.2s' : 'none',
                                transition: 'all 0.3s ease'
                            }}>
                                {formatPercent(state.strategyPerformance.drawdown)}
                            </div>
                        </div>
                        <div style={{ 
                            textAlign: 'center',
                            animation: isAnimating ? 'slideInUp 0.6s ease-out 0.4s both' : 'none'
                        }}>
                            <div style={{ color: '#888', fontSize: '0.9rem', marginBottom: '0.25rem' }}>Win Rate</div>
                            <div style={{ 
                                color: '#fff', 
                                fontSize: '1.5rem', 
                                fontWeight: '700',
                                animation: isAnimating ? 'numberChange 0.8s ease-out 0.3s' : 'none',
                                transition: 'all 0.3s ease'
                            }}>
                                {formatPercent(state.strategyPerformance.winRate)}
                            </div>
                        </div>
                    </div>
                    
                    <div style={{
                        background: 'rgba(255, 255, 255, 0.05)',
                        padding: '1rem',
                        borderRadius: '8px',
                        border: '1px solid #333',
                        height: '200px',
                        animation: isAnimating ? 'slideInUp 0.6s ease-out 0.5s both' : 'none',
                        transition: 'all 0.3s ease',
                        position: 'relative',
                        overflow: 'hidden'
                    }}>
                        <EquityCurveChart 
                            data={state.strategyPerformance.equityCurve}
                            isAnimating={isAnimating}
                        />
                    </div>
                </div>
            );
        };
        
        // Event Analysis Component
        const EventAnalysis = () => {
            const [diagnosticData, setDiagnosticData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [lastUpdate, setLastUpdate] = useState('00:00');
            const [selectedDate, setSelectedDate] = useState(new Date().toISOString().split('T')[0]);
            const [dateChanged, setDateChanged] = useState(false);

            const fetchDiagnosticAnalysis = async (date = null) => {
                setLoading(true);
                try {
                    // Use provided date or current selectedDate
                    const targetDate = date || selectedDate;
                    
                    // Add cache-busting parameter to ensure fresh data
                    const timestamp = new Date().getTime();
                    const response = await fetch(`/api/v1/futureexploratorium/events/diagnostic?date=${targetDate}&_t=${timestamp}`);
                    const data = await response.json();
                    
                    if (data.success) {
                        setDiagnosticData(data);
                        setDateChanged(false); // Reset date changed flag
                        setLastUpdate(new Date().toLocaleTimeString('en-US', { 
                            hour12: false, 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        }));
                    } else {
                        console.error('Diagnostic analysis failed:', data.error);
                        setDiagnosticData(null);
                    }
                } catch (error) {
                    console.error('Error fetching diagnostic analysis:', error);
                    setDiagnosticData(null);
                } finally {
                    setLoading(false);
                }
            };

            useEffect(() => {
                // Only fetch on initial load when selectedDate is set
                if (selectedDate) {
                    fetchDiagnosticAnalysis(selectedDate);
                }
            }, []);

            const handleDateChange = (e) => {
                const newDate = e.target.value;
                setSelectedDate(newDate);
                setDateChanged(true); // Mark that date has changed
                setDiagnosticData(null); // Clear previous data when date changes
                // Don't automatically fetch - user must click analyze button
            };

            if (loading) {
                return (
                    <div style={{
                        background: 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%)',
                        borderRadius: '16px',
                        padding: '1.5rem',
                        border: '1px solid #333',
                        boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)',
                        height: 'fit-content'
                    }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                            <h3 style={{ margin: 0, color: '#ffffff', fontSize: '1.25rem', fontWeight: '600' }}>
                                üîç Diagnostic Event Analysis
                            </h3>
                            <button onClick={() => fetchDiagnosticAnalysis()} style={{
                                background: '#007bff', color: 'white', border: 'none', padding: '8px 16px', borderRadius: '6px', cursor: 'pointer'
                            }}>
                                üîÑ
                            </button>
                        </div>
                        <div style={{ textAlign: 'center', padding: '20px', color: '#9ca3af' }}>
                            <div style={{ marginBottom: '10px' }}>ü§ñ AI is analyzing market events...</div>
                            <div style={{ fontSize: '0.8rem' }}>This may take a few moments</div>
                        </div>
                    </div>
                );
            }

            return (
                <div style={{
                    background: 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%)',
                    borderRadius: '16px',
                    padding: '1.5rem',
                    border: '1px solid #333',
                    boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)',
                    height: 'fit-content'
                }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' }}>
                        <h3 style={{ margin: 0, color: '#ffffff', fontSize: '1.25rem', fontWeight: '600' }}>
                            üîç Diagnostic Event Analysis
                        </h3>
                        <div>
                            <span style={{ marginRight: '12px', color: '#9ca3af', fontSize: '0.8rem' }}>{lastUpdate}</span>
                            <button onClick={() => fetchDiagnosticAnalysis()} style={{
                                background: '#007bff', color: 'white', border: 'none', padding: '8px 16px', borderRadius: '6px', cursor: 'pointer'
                            }}>
                                üîÑ
                            </button>
                        </div>
                    </div>

                    {/* Date Selector */}
                    <div style={{ display: 'flex', gap: '10px', marginBottom: '16px', flexWrap: 'wrap' }}>
                        <div style={{ flex: '1', minWidth: '120px' }}>
                            <label style={{ display: 'block', color: '#9ca3af', fontSize: '0.8rem', marginBottom: '4px' }}>Date</label>
                            <input
                                type="date"
                                value={selectedDate}
                                onChange={handleDateChange}
                                style={{
                                    width: '100%',
                                    padding: '6px 8px',
                                    borderRadius: '4px',
                                    border: '1px solid #444',
                                    background: '#333',
                                    color: '#ffffff',
                                    fontSize: '0.8rem'
                                }}
                            />
                        </div>
                        <div style={{ flex: '0 0 auto', display: 'flex', alignItems: 'end', gap: '8px' }}>
                            {dateChanged && (
                                <span style={{ 
                                    color: '#ffc107', 
                                    fontSize: '0.8rem', 
                                    fontWeight: '500',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '4px'
                                }}>
                                    ‚ö†Ô∏è Date changed - click analyze
                                </span>
                            )}
                            <button 
                                onClick={() => fetchDiagnosticAnalysis(selectedDate)}
                                disabled={loading}
                                style={{
                                    background: loading ? '#6c757d' : (dateChanged ? '#ffc107' : '#28a745'),
                                    color: 'white',
                                    border: 'none',
                                    padding: '8px 16px',
                                    borderRadius: '6px',
                                    cursor: loading ? 'not-allowed' : 'pointer',
                                    fontSize: '0.9rem',
                                    fontWeight: '500',
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '6px',
                                    height: 'fit-content'
                                }}
                            >
                                {loading ? '‚è≥' : 'üîç'} {loading ? 'Analyzing...' : 'Analyze Date'}
                            </button>
                        </div>
                    </div>


                    {/* Factor Impact Table */}
                    {diagnosticData?.factor_impact_table ? (
                        <div style={{ marginBottom: '16px' }}>
                            <h4 style={{ marginBottom: '12px', color: '#ffffff', fontSize: '1rem' }}>FACTOR IMPACT ON {selectedDate}</h4>
                            <div style={{ maxHeight: '300px', overflowY: 'auto' }}>
                                <table style={{ width: '100%', borderCollapse: 'collapse' }}>
                                    <thead>
                                        <tr>
                                            <th style={{ background: '#333', padding: '8px', textAlign: 'left', fontWeight: '600', color: '#ffffff', border: '1px solid #444', fontSize: '0.8rem' }}>FACTOR</th>
                                            <th style={{ background: '#333', padding: '8px', textAlign: 'left', fontWeight: '600', color: '#ffffff', border: '1px solid #444', fontSize: '0.8rem' }}>TYPE</th>
                                            <th style={{ background: '#333', padding: '8px', textAlign: 'left', fontWeight: '600', color: '#ffffff', border: '1px solid #444', fontSize: '0.8rem' }}>IMPACT ON {selectedDate}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {diagnosticData.factor_impact_table.map((factor, index) => (
                                            <tr key={index}>
                                                <td style={{ padding: '8px', border: '1px solid #444', color: '#ffffff', fontSize: '0.8rem', fontWeight: '500' }}>
                                                    {factor.factor}
                                                </td>
                                                <td style={{ padding: '8px', border: '1px solid #444', color: '#ffffff', fontSize: '0.8rem' }}>
                                                    <span style={{
                                                        background: '#444',
                                                        color: '#ffffff',
                                                        padding: '2px 6px',
                                                        borderRadius: '4px',
                                                        fontSize: '0.7rem'
                                                    }}>
                                                        {factor.factor_type || 'Unknown'}
                                                    </span>
                                                </td>
                                                <td style={{ padding: '8px', border: '1px solid #444', color: '#ffffff', fontSize: '0.8rem' }}>
                                                    {factor.impact}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ) : diagnosticData && !diagnosticData.factor_impact_table ? (
                        <div style={{
                            textAlign: 'center',
                            color: '#ff6b6b',
                            padding: '20px',
                            fontSize: '0.9rem',
                            background: '#2a2a2a',
                            borderRadius: '8px',
                            marginBottom: '16px'
                        }}>
                            No factor impact data available for {selectedDate}.
                        </div>
                    ) : null}



                    {/* No Data Message */}
                    {!diagnosticData && !loading && (
                        <div style={{
                            textAlign: 'center',
                            padding: '20px',
                            color: '#9ca3af',
                            fontSize: '0.9rem'
                        }}>
                            No diagnostic data available for {selectedDate}
                        </div>
                    )}
                </div>
            );
        };
        
        // Main App Component

        const FuturesExploratoriumApp = () => {
            const [state, setState] = useState(store.getState());
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                const unsubscribe = store.subscribe(setState);
                return unsubscribe;
            }, []);
            
            // Initialize app data
            useEffect(() => {
                const initializeApp = async () => {
                    try {
                        setLoading(true);
                        
                        // Demo mode: Skip API calls and use mock data directly
                        console.log('Demo mode: Using mock data instead of API calls');
                        
                        // Simulate API call delay
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Initialize with mock system health data
                        store.setState({
                            systemHealth: {
                                status: 'healthy',
                                score: 0.95,
                                uptime: '99.9%',
                                lastUpdate: new Date()
                            }
                        });
                        
                        // Initialize with mock market data
                        const generateSparkline = (basePrice, volatility = 0.02) => {
                            const points = [];
                            for (let i = 0; i < 20; i++) {
                                const change = (Math.random() - 0.5) * volatility * basePrice;
                                points.push(basePrice + change);
                            }
                            return points;
                        };
                        
                        store.setState({
                            marketData: {
                                ES: {
                                    price: 4250.50 + (Math.random() - 0.5) * 50,
                                    change: (Math.random() - 0.5) * 20,
                                    changePercent: (Math.random() - 0.5) * 0.01,
                                    volume: 1500000 + Math.random() * 500000,
                                    sparkline: generateSparkline(4250.50)
                                },
                                NQ: {
                                    price: 14500.25 + (Math.random() - 0.5) * 100,
                                    change: (Math.random() - 0.5) * 40,
                                    changePercent: (Math.random() - 0.5) * 0.01,
                                    volume: 800000 + Math.random() * 300000,
                                    sparkline: generateSparkline(14500.25)
                                },
                                RTY: {
                                    price: 1850.75 + (Math.random() - 0.5) * 20,
                                    change: (Math.random() - 0.5) * 10,
                                    changePercent: (Math.random() - 0.5) * 0.01,
                                    volume: 450000 + Math.random() * 200000,
                                    sparkline: generateSparkline(1850.75)
                                }
                            }
                        });
                        
                        // Initialize with mock strategy performance data
                        store.setState({
                            strategyPerformance: {
                                pnl: 1250.75 + (Math.random() - 0.5) * 1000,
                                sharpe: 1.2 + Math.random() * 1.0,
                                drawdown: -0.05 - Math.random() * 0.1,
                                winRate: 0.6 + Math.random() * 0.2,
                                equityCurve: generateSampleEquityCurve(),
                                isRunningBacktest: false
                            }
                        });
                        
                        
                        store.setState({ lastUpdate: new Date() });
                        
                        setLoading(false);
                        
                    } catch (error) {
                        console.error('Error initializing app:', error);
                        setLoading(false);
                    }
                };
                
                initializeApp();
            }, []);
            
            // Demo mode: Skip WebSocket connection entirely
            useEffect(() => {
                // Skip WebSocket in demo mode
                console.log('Demo mode: WebSocket connection disabled');
                store.setState({ isConnected: false });
                
                // Skip WebSocket subscriptions in demo mode
                
                // Demo mode: simulate real-time updates
                const demoUpdateInterval = setInterval(() => {
                    const symbols = ['ES', 'NQ', 'RTY'];
                    const randomSymbol = symbols[Math.floor(Math.random() * symbols.length)];
                    const currentData = store.getState().marketData[randomSymbol];
                    
                    if (currentData) {
                        const priceChange = (Math.random() - 0.5) * 10;
                        const newPrice = currentData.price + priceChange;
                        const newChange = currentData.change + priceChange;
                        const newChangePercent = newChange / (newPrice - newChange);
                        
                        store.setState(prevState => ({
                            marketData: {
                                ...prevState.marketData,
                                [randomSymbol]: {
                                    ...prevState.marketData[randomSymbol],
                                    price: newPrice,
                                    change: newChange,
                                    changePercent: newChangePercent,
                                    volume: prevState.marketData[randomSymbol].volume + Math.floor(Math.random() * 10000),
                                    sparkline: [...(prevState.marketData[randomSymbol]?.sparkline || []).slice(-19), newPrice]
                                }
                            }
                        }));
                    }
                }, 5000); // Update every 5 seconds
                
                
                return () => {
                    clearInterval(demoUpdateInterval);
                };
            }, []);
            
            if (loading) {
                return (
                    <div style={{
                        display: 'flex',
                        justifyContent: 'center',
                        alignItems: 'center',
                        height: '400px',
                        color: '#888'
                    }}>
                        <div style={{ textAlign: 'center' }}>
                            <div style={{
                                width: '40px',
                                height: '40px',
                                border: '3px solid #333',
                                borderTop: '3px solid #00d4ff',
                                borderRadius: '50%',
                                animation: 'spin 1s linear infinite',
                                margin: '0 auto 1rem'
                            }} />
                            Loading Futures Exploratorium...
                        </div>
                    </div>
                );
            }
            
            return (
                <div style={{
                    minHeight: '100vh',
                    background: 'linear-gradient(135deg, #0a0a0a 0%, #1a1a1a 100%)',
                    color: '#ffffff',
                    padding: '0'
                }}>
                    <Header />
                    
                    <div className="main-content" style={{ maxWidth: '1400px', margin: '0 auto', padding: '0 2rem' }}>
                        
                        <div className="dashboard-grid" style={{
                            display: 'grid',
                            gridTemplateColumns: '1fr 1fr 1fr',
                            gap: '1.5rem',
                            marginBottom: '1.5rem'
                        }}>
                            <MarketOverview />
                            <StrategyPerformance />
                            <EventAnalysis />
                        </div>
                        
                    </div>
                </div>
            );
        };
        
        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('futures-exploratorium-root'));
        root.render(<FuturesExploratoriumApp />);
    </script>
    
    <script>
        // Auto-clear cache and force reload
        function forceReload() {
            // Clear browser cache
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // Force reload without cache
            window.location.reload(true);
        }
        
        // Auto-clear cache on page load
        window.addEventListener('load', function() {
            // Clear any stored cache
            if ('localStorage' in window) {
                localStorage.clear();
            }
            if ('sessionStorage' in window) {
                sessionStorage.clear();
            }
        });
        
        // Handle hover-triggered modals for "How it works" buttons
        document.addEventListener('DOMContentLoaded', function() {
            const howItWorksButtons = document.querySelectorAll('.how-it-works-btn');
            
            howItWorksButtons.forEach(button => {
                let modal = null;
                let timeoutId = null;
                
                button.addEventListener('mouseenter', function() {
                    const targetId = this.getAttribute('data-bs-target');
                    modal = new bootstrap.Modal(document.querySelector(targetId));
                    modal.show();
                });
                
                button.addEventListener('mouseleave', function() {
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }
                    timeoutId = setTimeout(() => {
                        if (modal) {
                            modal.hide();
                        }
                    }, 300); // Small delay to prevent immediate closing
                });
                
                // Also close modal when mouse leaves the modal itself
                const targetId = button.getAttribute('data-bs-target');
                const modalElement = document.querySelector(targetId);
                modalElement.addEventListener('mouseenter', function() {
                    if (timeoutId) {
                        clearTimeout(timeoutId);
                    }
                });
                
                modalElement.addEventListener('mouseleave', function() {
                    if (modal) {
                        modal.hide();
                    }
                });
            });
            
            // Debug Bootstrap tabs
            const tabLinks = document.querySelectorAll('#main-nav .nav-link');
            tabLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    console.log('Tab clicked:', this.textContent);
                    console.log('Target:', this.getAttribute('data-bs-target'));
                });
            });
            
            // Ensure Bootstrap tabs are working
            const tabElements = document.querySelectorAll('[data-bs-toggle="pill"]');
            tabElements.forEach(tab => {
                tab.addEventListener('shown.bs.tab', function(e) {
                    console.log('Tab shown:', e.target.textContent);
                    

                });
            });
            
            // Check if we should activate a specific tab (from monitoring page navigation)
            const activeTab = localStorage.getItem('activeTab');
            if (activeTab) {
                const targetTab = document.querySelector(`[data-bs-target="#${activeTab}-content"]`);
                if (targetTab) {
                    // Remove active class from current tab
                    document.querySelector('.nav-link.active').classList.remove('active');
                    document.querySelector('.tab-pane.show.active').classList.remove('show', 'active');
                    
                    // Activate the target tab
                    targetTab.classList.add('active');
                    targetTab.setAttribute('aria-selected', 'true');
                    
                    // Show the target content
                    const targetContent = document.getElementById(`${activeTab}-content`);
                    if (targetContent) {
                        targetContent.classList.add('show', 'active');
                    }
                }
                // Clear the stored tab
                localStorage.removeItem('activeTab');
            }
        });
        
        // Functions to enable Trade button after training
        function enableTradeButton() {
            const tradeBtn = document.getElementById('fq-start-paper-trading-btn');
            const statusText = document.getElementById('train-trade-status');
            
            if (tradeBtn) {
                tradeBtn.disabled = false;
                tradeBtn.classList.remove('btn-secondary');
                tradeBtn.classList.add('btn-success');
                tradeBtn.title = 'Start paper trading with trained models';
            }
            
            if (statusText) {
                statusText.innerHTML = '<i class="fas fa-check-circle text-success"></i> Training complete! Ready to Trade';
                statusText.className = 'text-success';
            }
        }
        
        function resetTradeButton() {
            const tradeBtn = document.getElementById('fq-start-paper-trading-btn');
            const statusText = document.getElementById('train-trade-status');
            
            if (tradeBtn) {
                tradeBtn.disabled = true;
                tradeBtn.classList.remove('btn-success');
                tradeBtn.classList.add('btn-secondary');
                tradeBtn.title = 'Start paper trading with trained models - Requires training first';
            }
            
            if (statusText) {
                statusText.innerHTML = '<i class="fas fa-info-circle"></i> Train first, then Trade';
                statusText.className = 'text-muted';
            }
        }
        
        // Make functions globally available
        window.enableTradeButton = enableTradeButton;
        window.resetTradeButton = resetTradeButton;

        // Store chart instances globally
        window.fqCharts = {
            price: null,
            distribution: null,
            priceMain: null,
            distributionMain: null
        };

        // Global chart instances
        let priceChartInstance = null;
        let distributionChartInstance = null;

        // Function to load real chart data from API
        async function loadChartData(symbol = 'ES=F', timeframe = '1d', limit = 100) {
            const loadingElement = document.getElementById('chart-loading');
            const canvas = document.getElementById('price-chart');
            
            if (loadingElement) loadingElement.style.display = 'block';
            
            try {
                console.log(`Loading chart data for ${symbol}...`);
                const response = await fetch(`/api/v1/futureexploratorium/dashboard/chart?symbol=${symbol}&timeframe=${timeframe}&limit=${limit}`);
                const data = await response.json();
                
                if (data.success && data.chart_data && data.chart_data.length > 0) {
                    console.log('Chart data loaded successfully:', data.chart_data.length, 'data points');
                    createPriceChart(data.chart_data);
                } else {
                    console.warn('No chart data available, using sample data');
                    createPriceChart(null);
                }
            } catch (error) {
                console.error('Error loading chart data:', error);
                createPriceChart(null);
            } finally {
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        // Function to create price chart
        function createPriceChart(data = null) {
            const canvas = document.getElementById('price-chart');
            if (!canvas) {
                console.error('Price chart canvas not found!');
                return;
            }

            // Destroy existing chart if it exists
            if (priceChartInstance) {
                priceChartInstance.destroy();
            }

            console.log('Creating price chart...');
            
            let labels, priceData;
            if (data && data.length > 0) {
                // Use real data
                labels = data.map(item => {
                    const date = new Date(item.timestamp);
                    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                });
                priceData = data.map(item => item.close);
            } else {
                // Fallback to sample data
                labels = ['09:00', '10:00', '11:00', '12:00', '13:00', '14:00', '15:00', '16:00'];
                priceData = [100, 120, 115, 130, 125, 140, 135, 150];
            }

            const ctx = canvas.getContext('2d');
            priceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Price',
                        data: priceData,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Price Chart'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        }
                    }
                }
            });
            console.log('Price chart created!');
        }

        // Function to load distribution data from API
        async function loadDistributionData(symbol = 'ES=F') {
            const loadingElement = document.getElementById('distribution-loading');
            
            if (loadingElement) loadingElement.style.display = 'block';
            
            try {
                console.log(`Loading distribution data for ${symbol}...`);
                const response = await fetch(`/api/v1/futureexploratorium/dashboard/comprehensive`);
                const data = await response.json();
                
                if (data.success && data.distribution_analysis) {
                    console.log('Distribution data loaded successfully');
                    createDistributionChart(data.distribution_analysis);
                } else {
                    console.warn('No distribution data available, using sample data');
                    createDistributionChart(null);
                }
            } catch (error) {
                console.error('Error loading distribution data:', error);
                createDistributionChart(null);
            } finally {
                if (loadingElement) loadingElement.style.display = 'none';
            }
        }

        // Function to create distribution chart
        function createDistributionChart(data = null) {
            const canvas = document.getElementById('distribution-chart');
            if (!canvas) {
                console.error('Distribution chart canvas not found!');
                return;
            }

            // Destroy existing chart if it exists
            if (distributionChartInstance) {
                distributionChartInstance.destroy();
            }

            console.log('Creating distribution chart...');
            
            let labels, distributionData;
            if (data && data.quantiles) {
                // Use real data
                labels = ['Q10', 'Q25', 'Q50', 'Q75', 'Q90'];
                distributionData = [
                    data.quantiles.q10 || -3.2,
                    data.quantiles.q25 || -1.8,
                    data.quantiles.q50 || 0.5,
                    data.quantiles.q75 || 2.1,
                    data.quantiles.q90 || 4.2
                ];
            } else {
                // Fallback to sample data
                labels = ['Q10', 'Q25', 'Q50', 'Q75', 'Q90'];
                distributionData = [-3.2, -1.8, 0.5, 2.1, 4.2];
            }

            const ctx = canvas.getContext('2d');
            distributionChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Return Distribution (%)',
                        data: distributionData,
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(0, 123, 255, 0.8)',
                            'rgba(111, 66, 193, 0.8)'
                        ],
                        borderColor: [
                            'rgba(220, 53, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(0, 123, 255, 1)',
                            'rgba(111, 66, 193, 1)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Distribution'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Return (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Percentiles'
                            }
                        }
                    }
                }
            });
            console.log('Distribution chart created!');
        }

        // Function to create main price chart (second section)
        function createMainPriceChart() {
            const priceCanvas = document.getElementById('fq-price-chart-main');
            if (!priceCanvas) {
                console.error('Main price chart canvas not found!');
                return;
            }

            // Destroy existing chart if it exists
            if (window.fqCharts.priceMain) {
                window.fqCharts.priceMain.destroy();
            }

            console.log('Creating main price chart...');
            const priceCtx = priceCanvas.getContext('2d');
            window.fqCharts.priceMain = new Chart(priceCtx, {
                type: 'line',
                data: {
                    labels: ['9:30', '10:00', '10:30', '11:00', '11:30', '12:00', '12:30', '13:00', '13:30', '14:00', '14:30', '15:00', '15:30', '16:00'],
                    datasets: [{
                        label: 'ES=F Price',
                        data: [4850.25, 4852.50, 4848.75, 4855.00, 4851.25, 4858.50, 4854.75, 4861.00, 4857.25, 4864.50, 4860.75, 4867.00, 4863.25, 4870.50],
                        borderColor: '#183153',
                        backgroundColor: 'rgba(24, 49, 83, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'E-mini S&P 500 Futures - Live Price'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: 'Price ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Time (ET)'
                            }
                        }
                    }
                }
            });
            console.log('Main price chart created!');
        }

        // Function to create main distribution chart (second section)
        function createMainDistributionChart() {
            const distCanvas = document.getElementById('fq-distribution-chart-main');
            if (!distCanvas) {
                console.error('Main distribution chart canvas not found!');
                return;
            }

            // Destroy existing chart if it exists
            if (window.fqCharts.distributionMain) {
                window.fqCharts.distributionMain.destroy();
            }

            console.log('Creating main distribution chart...');
            const distCtx = distCanvas.getContext('2d');
            window.fqCharts.distributionMain = new Chart(distCtx, {
                type: 'bar',
                data: {
                    labels: ['Q10', 'Q25', 'Q50', 'Q75', 'Q90'],
                    datasets: [{
                        label: 'Return Distribution (%)',
                        data: [-2.8, -1.2, 0.8, 2.4, 4.1],
                        backgroundColor: [
                            'rgba(220, 53, 69, 0.8)',
                            'rgba(255, 193, 7, 0.8)',
                            'rgba(40, 167, 69, 0.8)',
                            'rgba(0, 123, 255, 0.8)',
                            'rgba(111, 66, 193, 0.8)'
                        ],
                        borderColor: [
                            'rgba(220, 53, 69, 1)',
                            'rgba(255, 193, 7, 1)',
                            'rgba(40, 167, 69, 1)',
                            'rgba(0, 123, 255, 1)',
                            'rgba(111, 66, 193, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Return Distribution Analysis'
                        },
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Return (%)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Percentiles'
                            }
                        }
                    }
                }
            });
            console.log('Main distribution chart created!');
        }

        // Update the forceCreateCharts function
        window.forceCreateCharts = async function() {
            console.log('Force creating all charts...');
            
            // Check if Chart.js is available
            if (typeof Chart === 'undefined') {
                alert('Chart.js not loaded! Please refresh the page.');
                return;
            }
            
            await createPriceChart();
            await createDistributionChart();
            createMainPriceChart();
            createMainDistributionChart();
        };

        // Global chart instances
        let simplePriceChart = null;
        let simpleDistributionChart = null;

        // Function to load data from Yahoo Finance via backend API
        async function loadYahooFinanceData(symbol) {
            try {
                console.log(`Loading Yahoo Finance data for ${symbol} (30 days)...`);
                const response = await fetch(`/api/v1/stocks/history?symbols=${symbol}&days=30`);
                const data = await response.json();
                
                if (data && data[symbol] && data[symbol].closes && data[symbol].closes.length > 0) {
                    console.log(`Loaded ${data[symbol].closes.length} data points for ${symbol}`);
                    return {
                        prices: data[symbol].closes,
                        times: data[symbol].dates,
                        symbol: symbol
                    };
                } else {
                    console.warn('No data received from Yahoo Finance API');
                    return null;
                }
            } catch (error) {
                console.error('Error loading Yahoo Finance data:', error);
                return null;
            }
        }

        // Function to calculate distribution data from price data
        function calculateDistribution(prices) {
            if (!prices || prices.length < 2) {
                return [-3.2, -1.8, 0.5, 2.1, 4.2]; // Default sample data
            }
            
            // Calculate returns
            const returns = [];
            for (let i = 1; i < prices.length; i++) {
                const return_pct = ((prices[i] - prices[i-1]) / prices[i-1]) * 100;
                returns.push(return_pct);
            }
            
            // Sort returns and calculate percentiles
            returns.sort((a, b) => a - b);
            const n = returns.length;
            
            return [
                returns[Math.floor(n * 0.1)] || -3.2,  // Q10
                returns[Math.floor(n * 0.25)] || -1.8, // Q25
                returns[Math.floor(n * 0.5)] || 0.5,   // Q50
                returns[Math.floor(n * 0.75)] || 2.1,  // Q75
                returns[Math.floor(n * 0.9)] || 4.2    // Q90
            ];
        }

        // Function to create charts with real data
        async function createChartsWithData(symbol = 'ES=F') {
            console.log(`Creating charts with data for ${symbol}...`);
            
            // Load data from Yahoo Finance
            const marketData = await loadYahooFinanceData(symbol);
            
            // Create price chart
            const priceCanvas = document.getElementById('simple-price-chart');
            if (priceCanvas && typeof Chart !== 'undefined') {
                // Destroy existing chart
                if (simplePriceChart) {
                    simplePriceChart.destroy();
                }
                
                const priceCtx = priceCanvas.getContext('2d');
                
                let labels, priceData;
                if (marketData && marketData.prices && marketData.prices.length > 0) {
                    // Use real data - format for monthly time series
                    labels = marketData.times.map(time => {
                        const date = new Date(time);
                        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    });
                    priceData = marketData.prices;
                } else {
                    // Fallback to sample data for 30 days
                    const sampleDates = [];
                    const samplePrices = [];
                    const basePrice = 4850;
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date();
                        date.setDate(date.getDate() - i);
                        sampleDates.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                        samplePrices.push(basePrice + (Math.random() - 0.5) * 100);
                    }
                    labels = sampleDates;
                    priceData = samplePrices;
                }
                
                simplePriceChart = new Chart(priceCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `${symbol} Price`,
                            data: priceData,
                            borderColor: '#007bff',
                            backgroundColor: 'rgba(0, 123, 255, 0.1)',
                            tension: 0.1,
                            fill: true,
                            pointRadius: 2,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${symbol} Price Chart (30 Days)`
                            },
                            legend: {
                                display: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                title: {
                                    display: true,
                                    text: 'Price'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Date'
                                },
                                ticks: {
                                    maxTicksLimit: 10 // Show only 10 date labels to avoid crowding
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
                console.log('Price chart created with data!');
            }

            // Create distribution chart
            const distCanvas = document.getElementById('simple-distribution-chart');
            if (distCanvas && typeof Chart !== 'undefined') {
                // Destroy existing chart
                if (simpleDistributionChart) {
                    simpleDistributionChart.destroy();
                }
                
                const distCtx = distCanvas.getContext('2d');
                
                let distributionData;
                if (marketData && marketData.prices && marketData.prices.length > 0) {
                    // Calculate real distribution from price data
                    distributionData = calculateDistribution(marketData.prices);
                } else {
                    // Fallback to sample data
                    distributionData = [-3.2, -1.8, 0.5, 2.1, 4.2];
                }
                
                simpleDistributionChart = new Chart(distCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Q10', 'Q25', 'Q50', 'Q75', 'Q90'],
                        datasets: [{
                            label: 'Return Distribution (%)',
                            data: distributionData,
                            backgroundColor: [
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(40, 167, 69, 0.8)',
                                'rgba(0, 123, 255, 0.8)',
                                'rgba(111, 66, 193, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `${symbol} Distribution`
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Return (%)'
                                }
                            }
                        }
                    }
                });
                console.log('Distribution chart created with data!');
            }
        }

        // Initialize charts when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing FutureQuant charts...');
            console.log('Chart.js available:', typeof Chart !== 'undefined');
            
            // Wait for Chart.js to load
            setTimeout(() => {
                if (typeof Chart !== 'undefined') {
                    // Load charts with default symbol
                    createChartsWithData('ES=F');
                    
                    // Add event listener to symbol selector
                    const symbolSelect = document.getElementById('fq-symbol-select');
                    if (symbolSelect) {
                        symbolSelect.addEventListener('change', function() {
                            const selectedSymbol = this.value;
                            if (selectedSymbol) {
                                console.log(`Symbol changed to: ${selectedSymbol}`);
                                createChartsWithData(selectedSymbol);
                            }
                        });
                        console.log('Symbol selector event listener added');
                    }
                } else {
                    console.error('Chart.js not loaded!');
                }
            }, 1000);
        });

        // Add a refresh function to reload chart data
        window.refreshCharts = async function() {
            console.log('Refreshing charts with new data...');
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not available');
                return;
            }
            
            try {
                loadChartData();
                loadDistributionData();
                console.log('Charts refresh initiated');
            } catch (error) {
                console.error('Error refreshing charts:', error);
            }
        };

        // Add a simple test function to verify charts work
        window.testCharts = function() {
            console.log('Testing charts...');
            console.log('Chart.js available:', typeof Chart !== 'undefined');
            
            const priceCanvas = document.getElementById('fq-price-chart');
            const distCanvas = document.getElementById('fq-distribution-chart');
            const priceMainCanvas = document.getElementById('fq-price-chart-main');
            const distMainCanvas = document.getElementById('fq-distribution-chart-main');
            
            console.log('Canvas elements found:');
            console.log('fq-price-chart:', priceCanvas);
            console.log('fq-distribution-chart:', distCanvas);
            console.log('fq-price-chart-main:', priceMainCanvas);
            console.log('fq-distribution-chart-main:', distMainCanvas);
            
            if (typeof Chart !== 'undefined') {
                // Create a simple test chart
                if (priceCanvas) {
                    const ctx = priceCanvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['A', 'B', 'C', 'D'],
                            datasets: [{
                                label: 'Test',
                                data: [1, 2, 3, 4],
                                borderColor: 'red'
                            }]
                        }
                    });
                    console.log('Test chart created on price canvas');
                }
            }
        };

        // Simple immediate chart creation
        window.createSimpleCharts = function() {
            console.log('Creating simple charts immediately...');
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not available');
                return;
            }

            // Create charts for all canvas elements
            const canvases = [
                'fq-price-chart',
                'fq-distribution-chart', 
                'fq-price-chart-main',
                'fq-distribution-chart-main'
            ];

            canvases.forEach(canvasId => {
                const canvas = document.getElementById(canvasId);
                if (canvas) {
                    console.log(`Creating chart for ${canvasId}`);
                    const ctx = canvas.getContext('2d');
                    
                    // Clear any existing chart
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    if (canvasId.includes('distribution')) {
                        // Bar chart for distribution
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: ['Q10', 'Q25', 'Q50', 'Q75', 'Q90'],
                                datasets: [{
                                    label: 'Distribution',
                                    data: [-2, -1, 0, 1, 2],
                                    backgroundColor: 'rgba(54, 162, 235, 0.8)',
                                    borderColor: 'rgba(54, 162, 235, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Distribution Chart'
                                    }
                                }
                            }
                        });
                    } else {
                        // Line chart for price
                        new Chart(ctx, {
                            type: 'line',
                            data: {
                                labels: ['9:30', '10:00', '10:30', '11:00', '11:30', '12:00'],
                                datasets: [{
                                    label: 'Price',
                                    data: [100, 102, 98, 105, 103, 107],
                                    borderColor: 'rgba(24, 49, 83, 1)',
                                    backgroundColor: 'rgba(24, 49, 83, 0.1)',
                                    tension: 0.1,
                                    fill: true
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    title: {
                                        display: true,
                                        text: 'Price Chart'
                                    }
                                }
                            }
                        });
                    }
                    console.log(`Chart created for ${canvasId}`);
                } else {
                    console.log(`Canvas ${canvasId} not found`);
                }
            });
        };

        // Mini Golf Strategy functions
        // Dynamic API base URL - works for both local and Railway deployment
        const API_BASE = window.location.protocol + '//' + window.location.host + '/api/v1';
        
        // Debug logging to verify the API_BASE is correct
        console.log('Current location:', window.location.href);
        console.log('API_BASE:', API_BASE);

        async function generateGolfStrategy() {
            const resultDiv = document.getElementById('golfStrategyResult');
            resultDiv.innerHTML = '<div class="alert alert-info">ü§ñ Generating AI strategy...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/minigolfstrategy/core/strategy/generate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        course_id: "demo-course",
                        hole_data: {
                            par: 4,
                            total_yardage: 420,
                            fairway_width: 35,
                            hazards: [
                                {
                                    start_distance: 240,
                                    end_distance: 270,
                                    penalty_strokes: 1.0,
                                    hazard_type: "water"
                                }
                            ],
                            green_size: 5000
                        },
                        conditions: {
                            wind_speed: -8,
                            wind_direction: 0,
                            temperature: 72,
                            humidity: 60,
                            course_firmness: 0.6
                        },
                        player_bag: [
                            { name: "Driver", carry_distance: 250, roll_distance: 22, accuracy_sigma: 20, loft_angle: 10 },
                            { name: "3W", carry_distance: 235, roll_distance: 15, accuracy_sigma: 18, loft_angle: 15 },
                            { name: "5i", carry_distance: 180, roll_distance: 6, accuracy_sigma: 12, loft_angle: 25 },
                            { name: "7i", carry_distance: 160, roll_distance: 4, accuracy_sigma: 10, loft_angle: 35 },
                            { name: "9i", carry_distance: 140, roll_distance: 2, accuracy_sigma: 8, loft_angle: 45 }
                        ]
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayGolfStrategyResult(data.strategy);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Failed to generate strategy'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function displayGolfStrategyResult(strategy) {
            const resultDiv = document.getElementById('golfStrategyResult');
            const recommended = strategy.recommended_strategy;
            
            resultDiv.innerHTML = `
                <div class="card" style="border-left: 4px solid #3498db;">
                    <div class="card-body">
                        <h5 class="card-title">üéØ Recommended Strategy</h5>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Club:</strong> ${recommended.club}</div>
                                <div class="mb-2"><strong>Expected Strokes:</strong> ${recommended.expected_strokes}</div>
                                <div class="mb-2"><strong>Confidence:</strong> ${(recommended.confidence_score * 100).toFixed(1)}%</div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Risk Level:</strong> <span style="color: ${recommended.risk_level === 'low' ? '#27ae60' : recommended.risk_level === 'medium' ? '#f39c12' : '#e74c3c'}">${recommended.risk_level.toUpperCase()}</span></div>
                                <div class="mb-2"><strong>Hazard Probability:</strong> ${(recommended.hazard_probability * 100).toFixed(1)}%</div>
                                <div class="mb-2"><strong>Remaining Distance:</strong> ${recommended.remaining_distance} yards</div>
                            </div>
                        </div>
                        
                        <h6 class="mt-3 mb-2">All Club Options</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-striped">
                                <thead>
                                    <tr>
                                        <th>Club</th>
                                        <th>Expected Strokes</th>
                                        <th>Confidence</th>
                                        <th>Risk</th>
                                        <th>Hazard Prob</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${strategy.all_strategies.map(s => `
                                        <tr style="${s.club === recommended.club ? 'background-color: #e8f5e8;' : ''}">
                                            <td><strong>${s.club}</strong></td>
                                            <td>${s.expected_strokes}</td>
                                            <td>${(s.confidence_score * 100).toFixed(1)}%</td>
                                            <td><span style="color: ${s.risk_level === 'low' ? '#27ae60' : s.risk_level === 'medium' ? '#f39c12' : '#e74c3c'}">${s.risk_level.toUpperCase()}</span></td>
                                            <td>${(s.hazard_probability * 100).toFixed(1)}%</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        }

        async function searchGolfCourses() {
            const resultDiv = document.getElementById('golfCourseResults');
            const query = document.getElementById('golfCourseQuery').value;
            
            resultDiv.innerHTML = '<div class="alert alert-info">üîç Searching courses...</div>';
            resultDiv.style.display = 'block';

            try {
                const response = await fetch(`${API_BASE}/minigolfstrategy/core/courses/search`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        limit: 10
                    })
                });

                const data = await response.json();
                
                if (data.success) {
                    displayGolfCourseResults(data.courses);
                } else {
                    resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${data.error || 'Failed to search courses'}</div>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }

        function displayGolfCourseResults(courses) {
            const resultDiv = document.getElementById('golfCourseResults');
            
            if (courses.length === 0) {
                resultDiv.innerHTML = '<div class="alert alert-warning">No courses found. Try a different search term.</div>';
                return;
            }

            resultDiv.innerHTML = `
                <h6 class="mb-3">üèåÔ∏è Found ${courses.length} Courses</h6>
                ${courses.map(course => `
                    <div class="card mb-2" style="border-left: 4px solid #27ae60;">
                        <div class="card-body py-2">
                            <h6 class="card-title mb-1">${course.name}</h6>
                            <p class="card-text mb-1 text-muted small">${course.location || 'Unknown'} ${course.country ? `(${course.country})` : ''}</p>
                            <p class="card-text mb-0 small">Par: ${course.par || 'Unknown'} | Yardage: ${course.yardage || 'Unknown'} ${course.slope_rating ? `| Slope: ${course.slope_rating}` : ''}</p>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function showComingSoon() {
            alert('üöß This feature is coming soon! Stay tuned for updates.');
        }

        // Golf Factor Analysis functions
        let selectedCourseId = null;
        let currentAnalysis = null;
        let recommendationsLoaded = false;

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            const targetDateInput = document.getElementById('targetDate');
            if (targetDateInput) {
                targetDateInput.value = today;
            }
            
            // Load top recommendations on page load since Golf Factor Analysis is now the default tab
            setTimeout(() => {
                loadTopRecommendations();
            }, 100); // Small delay to ensure tab content is visible
            
            // Setup state filter change handler
            handleStateFilterChange();
            
            // Add event listener for Mini Golf Strategy tab
            const minigolfTab = document.getElementById('minigolf-strategy-tab');
            if (minigolfTab) {
                minigolfTab.addEventListener('click', function() {
                    // Load recommendations only when tab is clicked and not already loaded
                    if (!recommendationsLoaded) {
                        setTimeout(() => {
                            loadTopRecommendations();
                        }, 100); // Small delay to ensure tab content is visible
                    }
                });
            }
        });


        // Display search results
        function displaySearchResults(courses) {
            const container = document.getElementById('courseList');
            const resultsDiv = document.getElementById('searchResults');
            
            if (courses.length === 0) {
                container.innerHTML = '<p class="text-muted">No courses found. Try a different search term.</p>';
            } else {
                container.innerHTML = courses.map(course => `
                    <div class="card mb-2" onclick="selectCourse('${course.id}', '${course.name}', '${course.club_name}')" style="border-left: 5px solid #7fb069; transition: all 0.3s ease; cursor: pointer; user-select: none;">
                        <div class="card-body">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6 class="card-title mb-1">${course.name}</h6>
                                    <p class="card-text text-muted mb-0" style="background: transparent !important; text-decoration: none !important; color: #6c757d !important; user-select: text !important;">
                                        <i class="fas fa-building me-1"></i>${course.club_name}
                                        <br>
                                        <i class="fas fa-map-marker-alt me-1"></i>${course.location.city}, ${course.location.state}
                                    </p>
                                </div>
                                <div class="col-md-4 text-md-end">
                                    <button class="btn btn-outline-primary btn-sm" style="border: 2px solid #2c5530; color: #2c5530; border-radius: 25px;">
                                        <i class="fas fa-chart-line me-1"></i>Analyze
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            resultsDiv.style.display = 'block';
        }

        // Select course for analysis
        async function selectCourse(courseId, courseName, clubName) {
            selectedCourseId = courseId;
            document.getElementById('selectedCourseName').innerHTML = 
                `<i class="fas fa-golf-ball-tee me-2"></i>${courseName}`;
            
            const targetDate = document.getElementById('targetDate').value;
            await analyzeCourse(courseId, targetDate);
        }

        // Analyze course timing
        async function analyzeCourse(courseId, targetDate) {
            showLoading('searchLoading');
            startLoadingTimer('searchLoading', 'timing analysis', 30);
            hideMessages();

            try {
                const params = new URLSearchParams();
                if (targetDate) {
                    params.append('target_date', targetDate);
                }

                const response = await fetch(`${API_BASE}/minigolfstrategy/factor-analysis/courses/${courseId}/timing-analysis?${params}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const analysis = await response.json();
                currentAnalysis = analysis;
                displayAnalysis(analysis);
                document.getElementById('courseAnalysis').style.display = 'block';
                scrollToElement('courseAnalysis');
                
            } catch (error) {
                console.error('Analysis error:', error);
                showError(`Analysis failed: ${error.message}`);
            } finally {
                stopLoadingTimer('searchLoading');
                setTimeout(() => {
                    hideLoading('searchLoading');
                }, 500); // Small delay to show completion
            }
        }

        // Display analysis results
        function displayAnalysis(analysis) {
            // Display factor analysis
            const factorContainer = document.getElementById('factorAnalysis');
            const scores = analysis.scores;
            
            factorContainer.innerHTML = `
                <div class="factor-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin: 0.5rem 0; background: #f8f9fa; border-radius: 10px;">
                    <div class="factor-name" style="font-weight: 600; color: #2d3436;">
                        <i class="fas fa-thermometer-half me-2"></i>Weather Conditions
                    </div>
                    <div class="factor-score ${getScoreClass(scores.weather)}" style="font-weight: 700; font-size: 1.1rem;">${scores.weather}/100</div>
                </div>
                <div class="factor-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin: 0.5rem 0; background: #f8f9fa; border-radius: 10px;">
                    <div class="factor-name" style="font-weight: 600; color: #2d3436;">
                        <i class="fas fa-calendar-alt me-2"></i>Seasonal Timing
                    </div>
                    <div class="factor-score ${getScoreClass(scores.seasonal)}" style="font-weight: 700; font-size: 1.1rem;">${scores.seasonal}/100</div>
                </div>
                <div class="factor-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin: 0.5rem 0; background: #f8f9fa; border-radius: 10px;">
                    <div class="factor-name" style="font-weight: 600; color: #2d3436;">
                        <i class="fas fa-users me-2"></i>Crowd Level
                    </div>
                    <div class="factor-score ${getScoreClass(scores.crowd)}" style="font-weight: 700; font-size: 1.1rem;">${scores.crowd}/100</div>
                </div>
                <div class="factor-item" style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; margin: 0.5rem 0; background: #f8f9fa; border-radius: 10px;">
                    <div class="factor-name" style="font-weight: 600; color: #2d3436;">
                        <i class="fas fa-golf-ball-tee me-2"></i>Course Condition
                    </div>
                    <div class="factor-score ${getScoreClass(scores.course_condition)}" style="font-weight: 700; font-size: 1.1rem;">${scores.course_condition}/100</div>
                </div>
            `;

            // Display weather information
            const weatherContainer = document.getElementById('weatherInfo');
            const weather = analysis.weather_data;
            
            weatherContainer.innerHTML = `
                <div class="row">
                    <div class="col-md-3 text-center">
                        <i class="fas fa-thermometer-half" style="font-size: 2rem; margin-right: 1rem; color: #007bff;"></i>
                        <div style="text-decoration: none !important;"><strong>${weather.current?.temperature || 'N/A'}¬∞F</strong></div>
                        <small class="text-muted" style="text-decoration: none !important;">Temperature</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <i class="fas fa-tint" style="font-size: 2rem; margin-right: 1rem; color: #17a2b8;"></i>
                        <div style="text-decoration: none !important;"><strong>${weather.current?.humidity || 'N/A'}%</strong></div>
                        <small class="text-muted" style="text-decoration: none !important;">Humidity</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <i class="fas fa-wind" style="font-size: 2rem; margin-right: 1rem; color: #ffc107;"></i>
                        <div style="text-decoration: none !important;"><strong>${weather.current?.wind_speed || 'N/A'} mph</strong></div>
                        <small class="text-muted" style="text-decoration: none !important;">Wind Speed</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <i class="fas fa-cloud" style="font-size: 2rem; margin-right: 1rem; color: #6c757d;"></i>
                        <div style="text-decoration: none !important;"><strong>${weather.current?.conditions || 'N/A'}</strong></div>
                        <small class="text-muted" style="text-decoration: none !important;">Conditions</small>
                    </div>
                </div>
            `;

            // Display AI recommendation
            document.getElementById('aiRecommendation').textContent = analysis.recommendation;
            
            // Display clothing recommendation
            const clothingRec = analysis.clothing_recommendation || "üëî Standard golf attire recommended\nüëï Bring light layers for temperature changes";
            document.getElementById('clothingRecommendation').textContent = clothingRec;

            // Display timing grade and overall score
            const overallScore = scores.overall;
            const grade = analysis.timing_grade;
            
            document.getElementById('timingGrade').textContent = grade;
            document.getElementById('timingGrade').className = `timing-grade grade-${grade.charAt(0).toLowerCase()}`;
            document.getElementById('overallScore').textContent = `${overallScore}/100`;
            document.getElementById('overallScore').className = `score-badge ${getScoreClass(overallScore)}`;
            
            // Grade explanation
            const explanations = {
                'A+': 'Excellent timing! Perfect conditions for golf.',
                'A': 'Great timing! Very good conditions.',
                'A-': 'Good timing! Favorable conditions.',
                'B+': 'Decent timing. Good conditions overall.',
                'B': 'Fair timing. Average conditions.',
                'B-': 'Okay timing. Some factors could be better.',
                'C+': 'Below average timing. Consider waiting.',
                'C': 'Poor timing. Not ideal conditions.',
                'C-': 'Bad timing. Wait for better conditions.',
                'D': 'Very poor timing. Avoid this time.'
            };
            
            document.getElementById('gradeExplanation').textContent = explanations[grade] || 'Timing analysis complete.';
        }

        // Get score CSS class
        function getScoreClass(score) {
            if (score >= 85) return 'score-excellent';
            if (score >= 70) return 'score-good';
            if (score >= 55) return 'score-fair';
            return 'score-poor';
        }

        
        // Handle state filter change
        function handleStateFilterChange() {
            const stateFilter = document.getElementById('stateFilter');
            if (stateFilter) {
                stateFilter.addEventListener('change', function() {
                    // Reset recommendations loaded flag to allow reloading
                    recommendationsLoaded = false;
                    // Load top recommendations for the selected state
                    loadTopRecommendations();
                });
            }
        }
        
        // Clean recommendation text by removing formatting tags
        function cleanRecommendationText(text) {
            if (!text) return '';
            
            // Remove [OUT] and [/OUT] tags
            return text
                .replace(/\[OUT\]/g, '')
                .replace(/\[\/OUT\]/g, '')
                .replace(/\[IN\]/g, '')
                .replace(/\[\/IN\]/g, '')
                .trim();
        }

        // Display course analysis results
        function displayCourseAnalysis(analysis) {
            const resultsContainer = document.getElementById('searchResults');
            if (!resultsContainer) return;
            
            resultsContainer.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Course Analysis Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>Overall Score</h6>
                                <div class="score-display ${getScoreClass(analysis.scores.overall)}">
                                    ${analysis.scores.overall}/100
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6>Timing Grade</h6>
                                <div class="grade-display">
                                    ${analysis.timing_grade}
                                </div>
                            </div>
                        </div>
                        <div class="mt-3">
                            <h6>Recommendation</h6>
                            <p>${analysis.recommendation}</p>
                        </div>
                        <div class="mt-3">
                            <h6>Weather Data</h6>
                            <p>Temperature: ${analysis.weather_data.temperature}¬∞F</p>
                            <p>Conditions: ${analysis.weather_data.conditions}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load top recommendations
        async function loadTopRecommendations() {
            // Prevent multiple simultaneous calls
            if (recommendationsLoaded) {
                return;
            }
            
            // Get selected state
            const stateFilter = document.getElementById('stateFilter');
            const selectedState = stateFilter ? stateFilter.value : '';
            
            const loadingDiv = document.getElementById('recommendationsLoading');
            if (loadingDiv) {
                loadingDiv.style.display = 'block';
                startLoadingTimer('recommendationsLoading', 'recommendations analysis', 45);
            }
            
            try {
                // Build URL with state parameter if selected
                let url = `${API_BASE}/minigolfstrategy/factor-analysis/courses/top-recommendations?limit=5&_t=${Date.now()}`;
                if (selectedState) {
                    url += `&state=${selectedState}`;
                }
                
                console.log('Making request to:', url);
                console.log('API_BASE is:', API_BASE);
                console.log('Selected state:', selectedState);
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                console.log('Recommendations API response:', data);
                
                if (data.recommendations && data.recommendations.length > 0) {
                    displayRecommendations(data.recommendations);
                    recommendationsLoaded = true; // Mark as loaded
                } else {
                    console.log('No recommendations found for state:', selectedState);
                    // Show a message when no recommendations are available
                    const container = document.getElementById('recommendationsList');
                    if (container) {
                        container.innerHTML = `
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                No recommendations available for ${selectedState || 'all locations'} at this time. 
                                Try selecting a different state or check back later.
                            </div>
                        `;
                    }
                    recommendationsLoaded = true; // Mark as loaded to prevent retries
                }
                
            } catch (error) {
                console.error('Recommendations error:', error);
                const container = document.getElementById('recommendationsList');
                if (container) {
                    container.innerHTML = '<p class="text-muted">Unable to load recommendations at this time.</p>';
                }
            } finally {
                if (loadingDiv) {
                    stopLoadingTimer('recommendationsLoading');
                    setTimeout(() => {
                        loadingDiv.style.display = 'none';
                    }, 500); // Small delay to show completion
                }
            }
        }

        // Display recommendations
        function displayRecommendations(recommendations) {
            const container = document.getElementById('recommendationsList');
            
            if (!container) return;
            
            if (recommendations.length === 0) {
                container.innerHTML = '<p class="text-muted">No recommendations available at this time.</p>';
                return;
            }

            container.innerHTML = recommendations.map((rec, index) => `
                <div class="card mb-3" onclick="selectCourse('${rec.course_id}', '${rec.course_name}', '${rec.club_name}')" style="border-left: 5px solid #7fb069; transition: all 0.3s ease; cursor: pointer;">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-1">
                                <div class="badge bg-primary rounded-circle" style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;">
                                    ${index + 1}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="card-title mb-1">${rec.course_name}</h6>
                                <p class="card-text text-muted mb-0">
                                    <i class="fas fa-building me-1"></i>${rec.club_name}
                                    <br>
                                    <i class="fas fa-map-marker-alt me-1"></i>${rec.location.city}, ${rec.location.state}
                                </p>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="score-badge ${getScoreClass(rec.overall_score)}" style="display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; font-size: 1.1rem;">${rec.overall_score}/100</div>
                                    <div class="timing-grade grade-${rec.timing_grade.charAt(0).toLowerCase()}" style="font-size: 1.5rem; font-weight: 900; margin: 0.5rem 0;">${rec.timing_grade}</div>
                                </div>
                            </div>
                            <div class="col-md-2 text-md-end">
                                <button class="btn btn-outline-primary btn-sm" style="border: 2px solid #2c5530; color: #2c5530; border-radius: 25px;">
                                    <i class="fas fa-chart-line me-1"></i>Analyze
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted" style="background: transparent !important; text-decoration: none !important; color: #6c757d !important; user-select: text !important;">${cleanRecommendationText(rec.recommendation)}</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Get weather forecast
        async function getWeatherForecast() {
            if (!selectedCourseId) {
                showError('Please select a course first');
                return;
            }

            showLoading('searchLoading');
            startLoadingTimer('searchLoading', 'weather forecast', 25);
            
            try {
                const response = await fetch(`${API_BASE}/minigolfstrategy/factor-analysis/courses/${selectedCourseId}/forecast?days=5`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                displayForecast(data.forecast);
                document.getElementById('weatherForecast').style.display = 'block';
                scrollToElement('weatherForecast');
                
            } catch (error) {
                console.error('Forecast error:', error);
                showError(`Forecast failed: ${error.message}`);
            } finally {
                stopLoadingTimer('searchLoading');
                setTimeout(() => {
                    hideLoading('searchLoading');
                }, 500); // Small delay to show completion
            }
        }

        // Display weather forecast
        function displayForecast(forecast) {
            const container = document.getElementById('forecastContainer');
            
            container.innerHTML = forecast.map(day => `
                <div class="col-md-2">
                    <div class="forecast-item" style="background: white; border-radius: 10px; padding: 1rem; margin: 0.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s ease;">
                        <div class="text-center">
                            <div class="fw-bold">${day.date}</div>
                            <div class="text-muted small">${day.time}</div>
                            <div class="mt-2">
                                <i class="fas fa-thermometer-half text-primary"></i>
                                <div class="fw-bold">${day.temperature}¬∞F</div>
                            </div>
                            <div class="mt-1">
                                <i class="fas fa-wind text-warning"></i>
                                <div class="small">${day.wind_speed} mph</div>
                            </div>
                            <div class="mt-1">
                                <i class="fas fa-tint text-info"></i>
                                <div class="small">${day.humidity}%</div>
                            </div>
                            <div class="mt-2">
                                <div class="score-badge ${getScoreClass(day.weather_score)}" style="display: inline-block; padding: 0.5rem 1rem; border-radius: 20px; font-weight: 700; font-size: 1.1rem;">${day.weather_score}</div>
                            </div>
                            <div class="mt-1 small text-muted">${day.conditions}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Analyze different date
        function analyzeDifferentDate() {
            if (!selectedCourseId) {
                showError('Please select a course first');
                return;
            }

            const newDate = prompt('Enter new date (YYYY-MM-DD):', document.getElementById('targetDate').value);
            if (newDate) {
                document.getElementById('targetDate').value = newDate;
                analyzeCourse(selectedCourseId, newDate);
            }
        }

        // Share analysis
        function shareAnalysis() {
            if (!currentAnalysis) {
                showError('No analysis to share');
                return;
            }

            const text = `Golf Factor Analysis for ${currentAnalysis.course_name}:
Overall Score: ${currentAnalysis.scores.overall}/100
Timing Grade: ${currentAnalysis.timing_grade}
Weather: ${currentAnalysis.weather_data.temperature}¬∞F, ${currentAnalysis.weather_data.conditions}
Recommendation: ${currentAnalysis.recommendation}`;

            if (navigator.share) {
                navigator.share({
                    title: 'Golf Factor Analysis',
                    text: text
                });
            } else {
                navigator.clipboard.writeText(text).then(() => {
                    showSuccess('Analysis copied to clipboard!');
                });
            }
        }

        // Utility functions
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'block';
            }
        }

        function hideLoading(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.style.display = 'none';
            }
        }

        // Loading timer management
        const loadingTimers = {};

        function startLoadingTimer(elementId, operationType = 'operation', timeoutSeconds = 30) {
            const startTime = Date.now();
            const progressBar = document.getElementById(elementId.replace('Loading', 'Progress'));
            const timerElement = document.getElementById(elementId.replace('Loading', 'Timer'));
            const loadingText = document.getElementById(elementId.replace('Loading', 'LoadingText'));
            
            if (!progressBar || !timerElement) return;

            // Reset progress
            progressBar.style.width = '0%';
            progressBar.classList.add('progress-bar-animated');
            
            // Update timer every 100ms
            const timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const seconds = Math.floor(elapsed / 1000);
                const milliseconds = Math.floor((elapsed % 1000) / 100);
                
                // Check for timeout
                if (seconds >= timeoutSeconds) {
                    timerElement.textContent = `Timeout after ${timeoutSeconds}s - Please try again`;
                    progressBar.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
                    loadingText.textContent = 'Operation timed out';
                    return;
                }
                
                // Update progress bar (simulate progress)
                const progress = Math.min(90, (elapsed / 1000) * 15); // 15% per second, max 90%
                progressBar.style.width = `${progress}%`;
                
                // Update timer text with different phases
                if (seconds < 1) {
                    timerElement.textContent = 'Initializing...';
                } else if (seconds < 3) {
                    timerElement.textContent = `Analyzing data... (${seconds}.${milliseconds}s)`;
                } else if (seconds < 6) {
                    timerElement.textContent = `Processing recommendations... (${seconds}.${milliseconds}s)`;
                } else if (seconds < 10) {
                    timerElement.textContent = `Finalizing results... (${seconds}.${milliseconds}s)`;
                } else if (seconds < 20) {
                    timerElement.textContent = `Taking longer than expected... (${seconds}.${milliseconds}s)`;
                } else {
                    timerElement.textContent = `Still processing... (${seconds}.${milliseconds}s) - ${timeoutSeconds - seconds}s remaining`;
                }
                
                // Update loading text based on operation and time
                if (loadingText) {
                    if (seconds < 2) {
                        loadingText.textContent = `Starting ${operationType}...`;
                    } else if (seconds < 5) {
                        loadingText.textContent = `Processing ${operationType}...`;
                    } else if (seconds < 15) {
                        loadingText.textContent = `Finalizing ${operationType}...`;
                    } else {
                        loadingText.textContent = `Complex analysis in progress...`;
                    }
                }
            }, 100);
            
            // Store timer for cleanup
            loadingTimers[elementId] = timerInterval;
            
            return timerInterval;
        }

        function stopLoadingTimer(elementId) {
            const progressBar = document.getElementById(elementId.replace('Loading', 'Progress'));
            const timerElement = document.getElementById(elementId.replace('Loading', 'Timer'));
            
            // Clear interval
            if (loadingTimers[elementId]) {
                clearInterval(loadingTimers[elementId]);
                delete loadingTimers[elementId];
            }
            
            // Complete progress bar
            if (progressBar) {
                progressBar.style.width = '100%';
                progressBar.classList.remove('progress-bar-animated');
            }
            
            // Update timer text
            if (timerElement) {
                timerElement.textContent = 'Complete!';
            }
        }

        function resetLoadingTimer(elementId) {
            const progressBar = document.getElementById(elementId.replace('Loading', 'Progress'));
            const timerElement = document.getElementById(elementId.replace('Loading', 'Timer'));
            
            // Clear any existing timer
            if (loadingTimers[elementId]) {
                clearInterval(loadingTimers[elementId]);
                delete loadingTimers[elementId];
            }
            
            // Reset progress bar
            if (progressBar) {
                progressBar.style.width = '0%';
                progressBar.classList.add('progress-bar-animated');
            }
            
            // Reset timer text
            if (timerElement) {
                timerElement.textContent = 'Starting...';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => errorDiv.style.display = 'none', 5000);
            }
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            if (successDiv) {
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                setTimeout(() => successDiv.style.display = 'none', 3000);
            }
        }

        function hideMessages() {
            const errorDiv = document.getElementById('errorMessage');
            const successDiv = document.getElementById('successMessage');
            if (errorDiv) errorDiv.style.display = 'none';
            if (successDiv) successDiv.style.display = 'none';
        }

        function scrollToElement(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

    </script>
</body>
</html> 
</html> 